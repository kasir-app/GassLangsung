<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langsung Gass - Super App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; -webkit-tap-highlight-color: transparent; }

        /* Splash Screen */
        #splash-screen { position: fixed; inset: 0; z-index: 9999; background: #16a34a; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #splash-screen.fade-out { opacity: 0; visibility: hidden; }

        /* Sidebar Animation */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        
        #overlay { transition: opacity 0.3s ease, visibility 0.3s; opacity: 0; visibility: hidden; }
        #overlay.show { opacity: 0.5; visibility: visible; }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 0; }

        /* Animations */
        @keyframes pulse-ring { 0% { transform: scale(0.33); } 80%, 100% { opacity: 0; } }
        .pulse-ring { animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .driver-modal-enter { transform: translateY(100%); opacity: 0; }
        .driver-modal-active { transform: translateY(0); opacity: 1; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 12px; font-size: 14px; animation: slideIn 0.3s ease-out forwards; pointer-events: auto; border-left: 4px solid #22c55e; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        
        /* Full Page Views */
        .full-page-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 60; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .full-page-view.active { transform: translateX(0); }
        .driver-icon-wrapper { transition: all 0.6s linear; display: flex; align-items: center; justify-content: center; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; outline: none; background: #f9fafb; }
        .form-input:focus { border-color: #16a34a; background: white; }

        /* Popup */
        #custom-popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        #custom-popup-overlay.show { opacity: 1; visibility: visible; }
        .popup-content { background: white; width: 85%; max-width: 320px; padding: 24px; border-radius: 20px; transform: scale(0.95); transition: transform 0.2s; }
        #custom-popup-overlay.show .popup-content { transform: scale(1); }
    </style>
</head>
<body class="h-screen w-full relative max-w-md mx-auto bg-white shadow-2xl overflow-hidden border-x border-gray-200">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-green-600 text-4xl shadow-lg mb-4 animate-bounce"><i class="fa-solid fa-location-dot"></i></div>
        <h1 class="text-white text-3xl font-bold tracking-tight">Langsung Gass</h1>
        <p class="text-white/80 text-sm mt-2" id="splash-text">Siap Meluncur...</p>
    </div>

    <div id="toast-container"></div>

    <!-- POPUP -->
    <div id="custom-popup-overlay">
        <div class="popup-content">
            <h3 class="text-lg font-bold mb-2" id="popup-title">Info</h3>
            <p class="text-gray-600 text-sm mb-5" id="popup-message">Pesan</p>
            <div id="popup-input-container" class="hidden mb-5"><input type="text" id="popup-input" class="form-input" placeholder="..."></div>
            <div class="flex justify-end gap-3">
                <button onclick="closeCustomPopup()" class="px-4 py-2 text-gray-500 text-sm font-medium">Batal</button>
                <button id="popup-confirm-btn" class="px-5 py-2 bg-green-600 text-white text-sm font-medium rounded-xl shadow-md">OK</button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="overlay" class="absolute inset-0 bg-black z-40" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="absolute top-0 left-0 h-full w-3/4 bg-white z-50 shadow-xl flex flex-col">
        <div class="p-6 bg-gradient-to-br from-green-600 to-emerald-700 text-white">
            <h1 class="text-2xl font-extrabold mb-6 tracking-tight">Langsung Gass</h1>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-green-600 font-bold text-2xl overflow-hidden border-4 border-white/20 shadow-inner"><i class="fa-solid fa-user" id="sidebar-avatar"></i></div>
                <div>
                    <h2 class="font-bold text-lg leading-tight" id="sidebar-username">Tamu</h2>
                    <p class="text-xs opacity-80 mt-1" id="sidebar-phone">...</p>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto py-2">
            <button onclick="openSidebarPage('history')" class="w-full flex items-center px-6 py-4 hover:bg-gray-50 text-gray-700"><i class="fa-solid fa-receipt w-8 text-center mr-3 text-green-600 text-lg"></i><span class="font-medium">Riwayat Pesanan</span></button>
            <button onclick="openSidebarPage('wallet')" class="w-full flex items-center px-6 py-4 hover:bg-gray-50 text-gray-700"><i class="fa-solid fa-wallet w-8 text-center mr-3 text-green-600 text-lg"></i><span class="font-medium">Dompet & Saldo</span></button>
            <div class="border-t my-2 mx-6 border-gray-200"></div>
            <p class="px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Akun</p>
            <button onclick="openSidebarPage('edit-profile')" class="w-full flex items-center px-6 py-3 hover:bg-gray-50 text-gray-700"><div class="w-8 flex justify-center mr-3"><i class="fa-solid fa-user-pen text-blue-600 text-lg"></i></div><span class="font-medium">Profil Penumpang</span></button>
            <button onclick="openSidebarPage('edit-driver')" class="w-full flex items-center px-6 py-3 hover:bg-gray-50 text-gray-700"><div class="w-8 flex justify-center mr-3"><i class="fa-solid fa-id-card text-purple-600 text-lg"></i></div><span class="font-medium">Profil Driver</span></button>
            <div class="border-t my-2 mx-6 border-gray-200"></div>
            <button onclick="safeLogout()" class="w-full flex items-center px-6 py-3 hover:bg-red-50 text-red-600 mt-2"><i class="fa-solid fa-right-from-bracket w-8 text-center mr-3 text-lg"></i><span class="font-bold">Keluar</span></button>
        </div>
        <div class="p-4 text-center text-xs text-gray-400 border-t bg-gray-50">
            <span id="app-status-dot" class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-1"></span> <span id="app-status-text">Mode Lokal</span>
        </div>
    </div>

    <!-- MAIN UI -->
    <div class="relative h-full flex flex-col">
        <div class="absolute top-0 left-0 w-full z-30 p-4 pt-6 flex justify-between items-start pointer-events-none">
            <button onclick="toggleSidebar()" class="pointer-events-auto w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-700 active:bg-gray-100 active:scale-95 transition-transform"><i class="fa-solid fa-bars text-lg"></i></button>
            <button onclick="openSidebarPage('wallet')" class="pointer-events-auto bg-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 active:bg-gray-50 active:scale-95 transition-transform"><i class="fa-solid fa-wallet text-blue-600"></i><span class="font-bold text-sm" id="header-balance">...</span></button>
        </div>

        <div id="map" class="flex-grow bg-gray-100 z-0"></div>

        <div id="main-panel" class="absolute bottom-0 left-0 w-full bg-white z-30 rounded-t-3xl shadow-[0_-5px_25px_rgba(0,0,0,0.1)] transition-all duration-300 ease-out" style="max-height: 85vh;">
            <div class="w-full flex justify-center pt-3 pb-1"><div class="w-12 h-1.5 bg-gray-200 rounded-full"></div></div>

            <!-- HOME -->
            <div id="view-home" class="p-5 pb-8">
                <h3 class="text-lg font-bold mb-5 text-gray-800" id="home-greeting">Mau kemana?</h3>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <button onclick="selectService('Motor')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 border border-green-100 group-hover:bg-green-100 transition-colors"><i class="fa-solid fa-motorcycle text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Motor</span></button>
                    <button onclick="selectService('Mobil')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 border border-green-100 group-hover:bg-green-100 transition-colors"><i class="fa-solid fa-car text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Mobil</span></button>
                    <button onclick="selectService('Makanan')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-500 border border-red-100 group-hover:bg-red-100 transition-colors"><i class="fa-solid fa-utensils text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Makan</span></button>
                    <button onclick="selectService('Kirim')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-500 border border-blue-100 group-hover:bg-blue-100 transition-colors"><i class="fa-solid fa-box text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Kirim</span></button>
                </div>
            </div>

            <!-- BOOKING -->
            <div id="view-booking" class="p-5 pb-8 hidden">
                <div class="flex items-center mb-4"><button onclick="goBack()" class="mr-4 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200"><i class="fa-solid fa-arrow-left text-sm"></i></button><h3 class="text-lg font-bold text-gray-800" id="service-title">Pesan</h3></div>
                <div class="relative pl-8 border-l-2 border-dashed border-gray-200 ml-4 space-y-5">
                    <div class="relative">
                        <div class="absolute -left-[39px] top-2 w-5 h-5 bg-green-100 rounded-full border-4 border-white shadow-sm flex items-center justify-center"><div class="w-2 h-2 bg-green-500 rounded-full"></div></div>
                        <label class="text-xs text-gray-500 font-bold uppercase mb-1 block">Jemput</label>
                        <div class="flex gap-2"><input type="text" id="pickup-input" placeholder="Cari lokasi jemput..." class="flex-1 bg-gray-50 border border-gray-200 p-3.5 rounded-xl text-sm font-medium text-gray-700"><button onclick="detectLocation()" id="gps-btn" class="bg-green-50 border border-green-100 text-green-600 w-12 rounded-xl flex items-center justify-center hover:bg-green-100"><i class="fa-solid fa-crosshairs"></i></button></div>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[39px] top-2 w-5 h-5 bg-red-100 rounded-full border-4 border-white shadow-sm flex items-center justify-center"><div class="w-2 h-2 bg-red-500 rounded-full"></div></div>
                        <label class="text-xs text-gray-500 font-bold uppercase mb-1 block">Tujuan</label>
                        <input type="text" id="dest-input" placeholder="Mau ke mana?" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl text-sm font-medium text-gray-700">
                    </div>
                </div>
                <div id="price-section" class="mt-6 hidden opacity-0 transition-all duration-500 transform translate-y-4">
                    <div class="flex justify-between items-center p-4 border border-green-100 bg-green-50/50 rounded-2xl mb-4">
                        <div class="flex items-center gap-3"><div class="w-10 h-10 bg-white rounded-full shadow-sm text-green-600 flex items-center justify-center"><i class="fa-solid fa-money-bill-wave"></i></div><div><p class="text-xs text-gray-500 font-medium">Estimasi Biaya</p><p class="font-bold text-gray-800 text-lg" id="price-tag">Rp 0</p></div></div>
                        <span id="distance-tag" class="text-xs bg-white border border-gray-200 px-2 py-1 rounded-lg text-gray-500 font-medium">0 km</span>
                    </div>
                    <button onclick="startOrder()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-600/30 hover:bg-green-700 transition-all active:scale-[0.99]">Pesan Sekarang</button>
                </div>
            </div>

            <!-- SEARCHING -->
            <div id="view-searching" class="p-8 pb-12 hidden text-center flex flex-col items-center">
                <div class="relative w-32 h-32 mb-8"><div class="absolute inset-0 bg-green-400 rounded-full opacity-20 pulse-ring"></div><div class="relative w-32 h-32 bg-white rounded-full border-[6px] border-green-50 flex items-center justify-center z-10 shadow-xl"><i class="fa-solid fa-magnifying-glass text-4xl text-green-500 animate-bounce"></i></div></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Mencari Driver...</h3>
                <p class="text-gray-500 text-sm max-w-[250px]">Menunggu driver menerima pesanan...</p>
                <button onclick="cancelOrder()" class="mt-8 text-red-500 font-bold text-sm border-2 border-red-100 px-8 py-3 rounded-full hover:bg-red-50 transition-colors">Batalkan</button>
            </div>

            <!-- DRIVER FOUND -->
            <div id="view-driver" class="p-5 pb-6 hidden">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800" id="trip-status">Menuju Lokasi</h3>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div> Live</span>
                </div>
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gray-100 rounded-full overflow-hidden border-2 border-white shadow-lg shrink-0"><img src="" alt="Driver" class="w-full h-full object-cover" id="img-driver-face"></div>
                    <div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 truncate text-lg" id="lbl-driver-name">...</h4><div class="flex items-center gap-2 text-sm text-gray-500 mt-1"><span class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-xs font-bold">5.0 â˜…</span><span class="font-mono font-medium text-gray-700 bg-gray-100 px-1.5 py-0.5 rounded" id="lbl-driver-plate">...</span></div></div>
                    <div class="flex gap-2"><button onclick="contactDriver()" class="w-11 h-11 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 shadow-lg active:scale-90 transition-transform"><i class="fa-brands fa-whatsapp text-xl"></i></button></div>
                </div>
                <button onclick="finishOrder()" class="w-full bg-gray-100 text-gray-600 font-bold py-4 rounded-xl hover:bg-gray-200 border border-gray-200 transition-colors">Selesaikan</button>
            </div>
        </div>
    </div>

    <!-- DRIVER APP MODAL (INCOMING ORDER) -->
    <div id="driver-app-modal" class="absolute inset-x-4 bottom-6 z-[70] hidden driver-modal-enter">
        <div class="bg-gray-900 text-white rounded-3xl shadow-2xl overflow-hidden border border-gray-700 ring-4 ring-black/20">
            <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div><span class="font-bold text-sm tracking-wide">DRIVER APP (ANDA)</span></div>
                <span class="text-xs text-gray-400 font-mono">ORDER MASUK</span>
            </div>
            <div class="p-6">
                <div class="text-center mb-6"><p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Lokasi Jemput</p><h3 class="text-lg font-bold text-white truncate px-4" id="driver-modal-customer">...</h3></div>
                <div class="flex justify-between items-center bg-gray-800/50 p-4 rounded-xl mb-6 border border-gray-700"><span class="text-sm text-gray-400">Pendapatan</span><span class="text-2xl font-bold text-green-400" id="driver-earn">Rp 0</span></div>
                <div class="flex gap-3"><button onclick="rejectOrder()" class="flex-1 py-3.5 rounded-xl font-bold text-sm border border-gray-600 text-gray-400 hover:bg-gray-800 transition-colors">Abaikan</button><button onclick="acceptOrder()" class="flex-[2] py-3.5 rounded-xl font-bold text-sm bg-green-600 text-white hover:bg-green-500 shadow-lg transition-colors">TERIMA</button></div>
            </div>
        </div>
    </div>

    <!-- PAGES -->
    <div id="page-edit-driver" class="full-page-view hidden">
        <div class="flex items-center mb-6"><button onclick="closePage('page-edit-driver')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Profil Driver</h2></div>
        <div class="flex justify-between items-center bg-green-50 p-4 rounded-xl border border-green-100 mb-6">
            <div><h4 class="font-bold text-sm text-gray-800">Status Driver</h4><p class="text-xs text-green-600 font-medium" id="driver-status-text">Aktif</p></div>
            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="driver-active-toggle" class="sr-only peer" onchange="toggleDriverStatus(this)"><div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label>
        </div>
        <div class="mb-6">
            <label class="text-xs font-bold text-gray-500 ml-1 mb-2 block">Kendaraan (Pilih minimal satu)</label>
            <div class="flex gap-3">
                <label class="flex-1 bg-white border border-gray-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition-all"><input type="checkbox" class="hidden" id="check-vehicle-motor" checked><i class="fa-solid fa-motorcycle text-green-600"></i><span class="text-sm font-medium text-gray-700">Motor</span></label>
                <label class="flex-1 bg-white border border-gray-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition-all"><input type="checkbox" class="hidden" id="check-vehicle-mobil" checked><i class="fa-solid fa-car text-green-600"></i><span class="text-sm font-medium text-gray-700">Mobil</span></label>
            </div>
        </div>
        <div class="space-y-4">
            <div><label class="text-xs font-bold text-gray-500 ml-1">Foto</label><div class="flex items-center gap-4 mt-2"><img id="preview-driver-photo" src="" class="w-16 h-16 rounded-full object-cover border border-gray-200 bg-gray-100"><label class="bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 cursor-pointer hover:bg-gray-200">Ubah <input type="file" class="hidden" accept="image/*" onchange="handlePhotoUpload(this)"></label></div></div>
            <div><label class="text-xs font-bold text-gray-500 ml-1">Nama</label><input type="text" id="input-driver-name" class="form-input mt-1"></div>
            <div><label class="text-xs font-bold text-gray-500 ml-1">Plat</label><input type="text" id="input-driver-plate" class="form-input mt-1"></div>
            <div><label class="text-xs font-bold text-gray-500 ml-1">No HP (WA)</label><input type="tel" id="input-driver-phone" class="form-input mt-1"></div>
            <button onclick="saveDriverProfile()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4 hover:bg-blue-700 transition-colors">Simpan Data Driver</button>
        </div>
    </div>

    <div id="page-edit-profile" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="closePage('page-edit-profile')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Profil Penumpang</h2></div><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 ml-1">Nama</label><input type="text" id="input-user-name" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">No HP</label><input type="tel" id="input-user-phone" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">Email</label><input type="email" id="input-user-email" class="form-input mt-1"></div><button onclick="saveUserProfile()" class="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4 hover:bg-green-700 transition-colors">Simpan Data</button></div></div>
    <div id="page-wallet" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="closePage('page-wallet')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex justify-center items-center"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Dompet</h2></div><div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg mb-6"><p class="text-sm opacity-80">Saldo</p><h1 class="text-3xl font-bold mt-1" id="wallet-balance-page">...</h1><button onclick="openTopUpModal()" class="mt-4 bg-white text-blue-600 px-4 py-2 rounded-lg font-bold text-sm w-full">Isi Saldo</button></div></div>
    <div id="page-history" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="closePage('page-history')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex justify-center items-center"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Riwayat</h2></div><div id="history-list" class="space-y-3"></div></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- MAIN SCRIPT - Window Scope (No Module) to ensure Global Access -->
    <script>
        // Error Handler
        window.onerror = function() { return true; };
        window.addEventListener('unhandledrejection', function(event) { event.preventDefault(); });

        // 1. DATA STORAGE
        const safeLocalStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } },
            setItem: (k, v) => { try { localStorage.setItem(k, v); } catch(e) {} }
        };

        let localUser = JSON.parse(safeLocalStorage.getItem('gotransite_user_local')) || { name: "User Baru", phone: "-", email: "", balance: 50000 };
        let localDriver = JSON.parse(safeLocalStorage.getItem('gotransite_driver_local')) || { 
            name: "Budi Santoso", plate: "B 1234 XYZ", phone: "6281234567890", 
            photo: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", 
            active: true, vehicleTypes: ['Motor', 'Mobil'] 
        };
        if(!localDriver.vehicleTypes) localDriver.vehicleTypes = ['Motor', 'Mobil'];

        // 2. FIREBASE HOOKS (Variables to be filled by module)
        window.firebaseUser = null;
        window.firebaseFunctions = {};

        // 3. UI FUNCTIONS (Globally Accessible)
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); };
        window.openSidebarPage = (id) => { window.toggleSidebar(); document.getElementById(`page-${id}`).classList.add('active'); document.getElementById(`page-${id}`).classList.remove('hidden'); };
        window.closePage = (id) => { document.getElementById(id).classList.remove('active'); setTimeout(() => document.getElementById(id).classList.add('hidden'), 300); };
        window.switchView = (id) => { ['view-home','view-booking','view-searching','view-driver'].forEach(v => document.getElementById(v).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); };
        window.selectService = (t) => { window.selectedServiceType = t; document.getElementById('service-title').innerText = t; window.switchView('booking'); };
        window.goBack = () => window.switchView('home');
        window.cancelOrder = () => { window.switchView('home'); window.showToast("Dibatalkan"); };
        window.finishOrder = () => { window.switchView('home'); window.showToast("Selesai"); };
        window.contactDriver = () => { if(window.currentDriverPhone) window.open(`https://wa.me/${window.currentDriverPhone}`, '_blank'); };
        window.showToast = (msg, type) => { const t = document.createElement('div'); t.className = `toast ${type||''} show`; t.innerHTML = `<span>${msg}</span>`; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); };
        
        // Popup Logic
        let onConfirm = null;
        window.openCustomPopup = (t, m, i, cb) => { document.getElementById('popup-title').innerText = t; document.getElementById('popup-message').innerText = m; const inp = document.getElementById('popup-input-container'); if(i) { inp.classList.remove('hidden'); document.getElementById('popup-input').value=''; } else inp.classList.add('hidden'); onConfirm = () => { cb(i ? document.getElementById('popup-input').value : true); window.closeCustomPopup(); }; document.getElementById('custom-popup-overlay').classList.remove('hidden'); };
        window.closeCustomPopup = () => document.getElementById('custom-popup-overlay').classList.add('hidden');
        document.getElementById('popup-confirm-btn').onclick = () => { if(onConfirm) onConfirm(); };
        window.openTopUpModal = () => window.openCustomPopup("Top Up", "Jumlah:", true, (v) => { localUser.balance += parseInt(v)||0; updateUserUI(localUser); });
        window.safeLogout = () => window.openCustomPopup("Keluar", "Yakin?", false, () => { location.reload(); });
        
        // Driver Modal Logic
        window.rejectOrder = () => { document.getElementById('driver-app-modal').classList.add('hidden'); };
        window.hideDriverModal = () => { document.getElementById('driver-app-modal').classList.add('hidden'); };
        window.acceptOrder = () => {
             // If Firebase is connected, this is overridden. If not, standard fallback.
             if(window.firebaseFunctions.acceptOrder) window.firebaseFunctions.acceptOrder();
             else { window.hideDriverModal(); window.showToast("Error Koneksi"); }
        };

        // UI Update Logic
        function updateUserUI(data) {
            if(data.name) {
                const firstName = data.name.split(' ')[0];
                const sbName = document.getElementById('sidebar-username');
                const hName = document.getElementById('home-greeting');
                if(sbName) sbName.innerText = data.name;
                if(hName) hName.innerText = `Halo, ${firstName}!`;
            }
            if(data.balance !== undefined) {
                const fmt = `Rp ${data.balance.toLocaleString('id-ID')}`;
                const hb = document.getElementById('header-balance');
                const wb = document.getElementById('wallet-balance-page');
                if(hb) hb.innerText = fmt;
                if(wb) wb.innerText = fmt;
            }
        }

        function updateDriverStatusText() {
            const el = document.getElementById('driver-status-text');
            if(el) {
                el.innerText = localDriver.active ? "Aktif" : "Non-Aktif";
                el.className = localDriver.active ? "text-xs text-green-600 font-medium" : "text-xs text-gray-400 font-medium";
            }
        }

        function populateForms() {
            if(document.getElementById('input-user-name')) {
                document.getElementById('input-user-name').value = localUser.name || "";
                document.getElementById('input-user-phone').value = localUser.phone || "";
                document.getElementById('input-user-email').value = localUser.email || "";
                document.getElementById('input-driver-name').value = localDriver.name || "";
                document.getElementById('input-driver-plate').value = localDriver.plate || "";
                document.getElementById('input-driver-phone').value = localDriver.phone || "";
                document.getElementById('preview-driver-photo').src = localDriver.photo || "";
                if(document.getElementById('driver-active-toggle')) document.getElementById('driver-active-toggle').checked = localDriver.active;
                document.getElementById('check-vehicle-motor').checked = localDriver.vehicleTypes.includes('Motor');
                document.getElementById('check-vehicle-mobil').checked = localDriver.vehicleTypes.includes('Mobil');
            }
            updateUserUI(localUser);
            updateDriverStatusText();
        }

        // SAVE LOGIC
        window.saveUserProfile = () => {
            const name = document.getElementById('input-user-name').value;
            const phone = document.getElementById('input-user-phone').value;
            const email = document.getElementById('input-user-email').value;
            
            // 1. Update Local & UI INSTANTLY
            localUser = { ...localUser, name, phone, email };
            safeLocalStorage.setItem('gotransite_user_local', JSON.stringify(localUser));
            updateUserUI(localUser);
            window.closePage('page-edit-profile');
            window.showToast("Profil Disimpan");

            // 2. Sync Cloud
            if(window.firebaseFunctions.saveUser) window.firebaseFunctions.saveUser(name, phone, email);
        };

        window.saveDriverProfile = () => {
            const name = document.getElementById('input-driver-name').value;
            const plate = document.getElementById('input-driver-plate').value;
            const phone = document.getElementById('input-driver-phone').value;
            const photo = document.getElementById('preview-driver-photo').src;
            const vTypes = [];
            if(document.getElementById('check-vehicle-motor').checked) vTypes.push('Motor');
            if(document.getElementById('check-vehicle-mobil').checked) vTypes.push('Mobil');
            
            localDriver = { ...localDriver, name, plate, phone, photo, vehicleTypes: vTypes };
            safeLocalStorage.setItem('gotransite_driver_local', JSON.stringify(localDriver));
            
            window.closePage('page-edit-driver');
            window.showToast("Profil Driver Disimpan");
            
            if(window.firebaseFunctions.saveDriver) window.firebaseFunctions.saveDriver(localDriver);
        };

        window.toggleDriverStatus = (el) => {
            localDriver.active = el.checked;
            updateDriverStatusText();
            safeLocalStorage.setItem('gotransite_driver_local', JSON.stringify(localDriver));
            if(window.firebaseFunctions.saveDriver) window.firebaseFunctions.saveDriver(localDriver);
        };

        window.handlePhotoUpload = (input) => {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { document.getElementById('preview-driver-photo').src = e.target.result; };
                r.readAsDataURL(input.files[0]);
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            populateForms();
            initMap();
            setTimeout(() => {
                 document.getElementById('splash-screen').classList.add('fade-out');
                 setTimeout(() => document.getElementById('splash-screen').remove(), 500);
            }, 1500);
        });

        // --- MAP & ORDER ---
        window.initMap = () => {
            if(!document.getElementById('map')) return;
            window.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-6.175392, 106.827153], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(window.map);
            window.userMarker = L.marker([-6.175392, 106.827153]).addTo(window.map);
        };
        window.detectLocation = () => {
            const btn = document.getElementById('gps-btn'); const input = document.getElementById('pickup-input'); const oldHtml = btn.innerHTML; btn.innerHTML = '...';
            if(!navigator.geolocation) { btn.innerHTML = oldHtml; handleLocationFallback("Monas (Simulasi)", -6.175392, 106.827153); return; }
            navigator.geolocation.getCurrentPosition(pos => { handleLocationSuccess("Lokasi Saya", pos.coords.latitude, pos.coords.longitude); btn.innerHTML = oldHtml; }, () => { handleLocationFallback("Monas (Simulasi)", -6.175392, 106.827153); btn.innerHTML = oldHtml; });
        };
        function handleLocationSuccess(text, lat, lng) { window.map.setView([lat, lng], 16); window.pickupCoords = { lat, lon: lng }; document.getElementById('pickup-input').value = text; if(window.pickupMarker) window.map.removeLayer(window.pickupMarker); window.pickupMarker = L.marker([lat, lng]).addTo(window.map); }
        function handleLocationFallback(text, lat, lng) { window.pickupCoords = { lat, lon: lng }; document.getElementById('pickup-input').value = text; window.map.setView([lat, lng], 16); if(window.pickupMarker) window.map.removeLayer(window.pickupMarker); window.pickupMarker = L.marker([lat, lng]).addTo(window.map); window.showToast("Lokasi Simulasi", "info"); }
        
        window.setupInputListeners = () => {
            let timeout = null;
            const handleSearch = (e, type) => {
                const val = e.target.value; if(val.length < 3) return; clearTimeout(timeout);
                timeout = setTimeout(() => {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=1`)
                        .then(r => r.json()).then(d => {
                            if(d && d.length > 0) {
                                const lat = parseFloat(d[0].lat), lon = parseFloat(d[0].lon);
                                window.map.flyTo([lat, lon], 16);
                                if(type === 'pickup') { if(window.pickupMarker) window.map.removeLayer(window.pickupMarker); window.pickupMarker = L.marker([lat, lon]).addTo(window.map); window.pickupCoords = {lat, lon}; } 
                                else { if(window.destMarker) window.map.removeLayer(window.destMarker); window.destMarker = L.marker([lat, lon]).addTo(window.map); window.destCoords = {lat, lon}; }
                                if(window.pickupCoords && window.destCoords) drawRoute();
                            }
                        }).catch(err => {}); 
                }, 800);
            };
            const pInput = document.getElementById('pickup-input'), dInput = document.getElementById('dest-input');
            if(pInput) pInput.addEventListener('input', (e) => handleSearch(e, 'pickup'));
            if(dInput) dInput.addEventListener('input', (e) => handleSearch(e, 'dest'));
        };

        async function drawRoute() {
            if(window.routePolyline) window.map.removeLayer(window.routePolyline);
            document.getElementById('price-section').classList.remove('hidden', 'opacity-0');
            const p1 = window.pickupCoords, p2 = window.destCoords;
            try {
                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lon},${p1.lat};${p2.lon},${p2.lat}?overview=full&geometries=geojson`);
                const data = await res.json();
                if(data.code !== "Ok") throw new Error();
                const route = data.routes[0];
                window.routePath = route.geometry.coordinates.map(c => [c[1], c[0]]);
                window.routePolyline = L.polyline(window.routePath, {color: '#2563eb', weight: 5}).addTo(window.map);
                const distKm = route.distance / 1000;
                window.calculatedPrice = Math.max(10000, Math.ceil(distKm * 3000));
                document.getElementById('distance-tag').innerText = `${distKm.toFixed(1)} km`;
            } catch(e) {
                window.routePath = [[p1.lat, p1.lon], [p2.lat, p2.lon]];
                window.routePolyline = L.polyline(window.routePath, {color: '#2563eb', weight: 5}).addTo(window.map);
                window.calculatedPrice = 15000;
            }
            window.map.fitBounds(window.routePolyline.getBounds(), {padding:[50,50]});
            document.getElementById('price-tag').innerText = `Rp ${window.calculatedPrice.toLocaleString('id-ID')}`;
        }
        
        window.startOrder = async () => {
             if(!window.pickupCoords || !window.destCoords) { window.showToast("Lengkapi lokasi", "error"); return; }
             window.switchView('searching');
             
             if(window.firebaseFunctions.startOrder) {
                 window.firebaseFunctions.startOrder();
             } else {
                 setTimeout(() => {
                     window.hideDriverModal(); 
                     window.showDriverFound({name: "Bot Driver", plate: "B 9999", photo: "", phone: ""});
                 }, 3000);
             }
        };
        
        window.showDriverFound = (drv) => { 
            window.switchView('driver'); 
            document.getElementById('lbl-driver-name').innerText = drv.name; 
            document.getElementById('lbl-driver-plate').innerText = drv.plate; 
            if(drv.photo) document.getElementById('img-driver-face').src = drv.photo; 
            window.currentDriverPhone = drv.phone; 
            if(window.routePath) setTimeout(animateVehicle, 1000); 
        };

        function animateVehicle() { if(!window.routePath) return; if(window.vehicleMarker) window.map.removeLayer(window.vehicleMarker); const icon = L.divIcon({html: '<div style="font-size:24px">ðŸš—</div>', className: 'driver-icon-wrapper'}); window.vehicleMarker = L.marker(window.routePath[0], {icon}).addTo(window.map); let i = 0; const path = window.routePath; function move() { if(i >= path.length) { window.showToast("Sampai!"); return; } const pos = path[i]; window.vehicleMarker.setLatLng(pos); window.map.panTo(pos, { animate: true, duration: 0.6 }); i++; setTimeout(() => requestAnimationFrame(move), 600); } move(); }
    </script>

    <!-- FIREBASE MODULE (Separated) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, addDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAfRv6lA2U2ntFu-jgzpm5uoBxSkPyjVC4", authDomain: "gotransite.firebaseapp.com", projectId: "gotransite", storageBucket: "gotransite.firebasestorage.app", messagingSenderId: "991886146654", appId: "1:991886146654:web:73648a5a791c322d20c8cf", measurementId: "G-JVGKB93E8K" };

        let db, userUid, activeOrderId, incomingOrderId;

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) { 
                    userUid = user.uid; 
                    window.firebaseUser = user;
                    document.getElementById('app-status-text').innerText = "Online";
                    document.getElementById('app-status-dot').classList.replace('bg-yellow-500', 'bg-green-500');
                    await loadCloudData();
                    if(localDriver.active) startListener();
                } else signInAnonymously(auth);
            });
        } catch(e) { console.log("Firebase Offline"); }

        async function loadCloudData() {
            try {
                const snap = await getDoc(doc(db, "users", userUid));
                if(snap.exists()) {
                    const d = snap.data();
                    localUser = { ...localUser, ...d };
                    localStorage.setItem('gotransite_user_local', JSON.stringify(localUser));
                    // Refresh UI again to sync cloud data
                    if(document.getElementById('sidebar-username')) document.getElementById('sidebar-username').innerText = localUser.name;
                    if(document.getElementById('home-greeting')) document.getElementById('home-greeting').innerText = `Halo, ${localUser.name.split(' ')[0]}!`;
                }
            } catch(e){}
        }

        // Attach Firebase Functions to Window
        window.firebaseFunctions.saveUser = async (n, p, e) => {
            if(userUid) await updateDoc(doc(db, "users", userUid), {name:n, phone:p, email:e});
        };
        
        window.firebaseFunctions.saveDriver = async (d) => {
            if(userUid) {
                await setDoc(doc(db, "users", userUid, "settings", "driver_profile"), d);
                if(d.active) startListener();
            }
        };

        window.firebaseFunctions.startOrder = async () => {
            try {
                const pickupName = document.getElementById('pickup-input').value || "Lokasi Jemput";
                const ref = await addDoc(collection(db, "orders"), { 
                    userId: userUid, customerName: localUser.name, pickupName: pickupName,
                    price: window.calculatedPrice, status: "searching", serviceType: window.selectedServiceType, createdAt: new Date() 
                });
                activeOrderId = ref.id;
                onSnapshot(doc(db, "orders", activeOrderId), (snap) => { 
                    const d = snap.data(); 
                    if(d && d.status === "accepted") { window.hideDriverModal(); window.showDriverFound(d.driver); } 
                });
                // Fallback for single user testing
                setTimeout(() => {
                    if(document.getElementById('view-searching').classList.contains('hidden')) return;
                    window.showDriverFound({name: "Joko Widodo", plate: "B 1234 RRI", photo: "https://api.dicebear.com/7.x/avataaars/svg?seed=Joko", phone: ""});
                    window.showToast("Driver Mitra ditugaskan", "info");
                }, 15000);
            } catch(e) { setTimeout(() => window.switchView('home'), 2000); }
        };

        window.firebaseFunctions.acceptOrder = async () => {
             if(incomingOrderId) {
                try {
                    await updateDoc(doc(db, "orders", incomingOrderId), { status: "accepted", driver: localDriver });
                    window.hideDriverModal(); window.showToast("Order Diterima!"); incomingOrderId = null;
                } catch(e) { window.hideDriverModal(); window.showToast("Telat!", "error"); }
            }
        };

        function startListener() {
            const q = query(collection(db, "orders"), where("status", "==", "searching"), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snap) => {
                snap.docChanges().forEach((c) => {
                    if(c.type === "added") {
                        const d = c.doc.data();
                        // ALLOW SELF ORDER FOR TESTING
                        const sType = d.serviceType || 'Motor';
                        if(localDriver.vehicleTypes.includes(sType)) {
                            incomingOrderId = c.doc.id;
                            const modal = document.getElementById('driver-app-modal');
                            document.getElementById('driver-modal-customer').innerText = d.pickupName || "Pelanggan"; 
                            document.getElementById('driver-earn').innerText = `Rp ${d.price.toLocaleString('id-ID')}`;
                            modal.classList.remove('hidden');
                            setTimeout(() => modal.classList.add('driver-modal-active'), 50);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>