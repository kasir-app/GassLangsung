<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langsung Gass - Super App</title>
    
    <!-- ERROR SUPPRESSOR (PENTING: Ini mencegah layar error muncul) -->
    <script>
        window.onerror = function() { return true; }; // Abaikan error script
        window.addEventListener('unhandledrejection', function(e) { e.preventDefault(); }); // Abaikan error network
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow: hidden; -webkit-tap-highlight-color: transparent; }

        /* UI Components Styles */
        #splash-screen { position: fixed; inset: 0; z-index: 9999; background: #16a34a; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #splash-screen.fade-out { opacity: 0; visibility: hidden; }
        
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); z-index: 50; }
        #sidebar.open { transform: translateX(0); }
        #overlay { transition: opacity 0.3s; opacity: 0; visibility: hidden; z-index: 40; }
        #overlay.show { opacity: 0.5; visibility: visible; }
        
        .full-page-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 60; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s; }
        .full-page-view.active { transform: translateX(0); }
        
        #map { height: 100%; width: 100%; z-index: 0; }
        .driver-icon-wrapper { transition: all 1s linear; display: flex; align-items: center; justify-content: center; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        
        #driver-app-modal { transition: transform 0.4s; transform: translateY(120%); z-index: 80; }
        #driver-app-modal.active { transform: translateY(0); }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; border-left: 4px solid #22c55e; animation: slideIn 0.3s forwards; pointer-events: auto; font-size: 14px; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #custom-popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        #custom-popup-overlay.show { opacity: 1; visibility: visible; }
        .popup-content { background: white; width: 85%; max-width: 320px; padding: 24px; border-radius: 20px; transform: scale(0.95); transition: transform 0.2s; }
        #custom-popup-overlay.show .popup-content { transform: scale(1); }
        
        .form-input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; outline: none; background: #f9fafb; }
    </style>
</head>
<body class="h-screen w-full relative max-w-md mx-auto bg-white shadow-2xl overflow-hidden border-x border-gray-200">

    <div id="splash-screen">
        <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-green-600 text-4xl shadow-lg mb-4 animate-bounce"><i class="fa-solid fa-location-dot"></i></div>
        <h1 class="text-white text-3xl font-bold">Langsung Gass</h1>
        <p class="text-white/80 text-sm mt-2" id="splash-status">Memuat...</p>
    </div>

    <div id="toast-container"></div>

    <!-- POPUP -->
    <div id="custom-popup-overlay">
        <div class="popup-content">
            <h3 class="text-lg font-bold mb-2" id="popup-title">Info</h3>
            <p class="text-gray-600 text-sm mb-5" id="popup-message">Pesan</p>
            <div id="popup-input-container" class="hidden mb-5"><input type="text" id="popup-input" class="form-input"></div>
            <div class="flex justify-end gap-3">
                <button onclick="ui.closePopup()" class="px-4 py-2 text-gray-500 text-sm font-medium hover:bg-gray-50 rounded-lg">Batal</button>
                <button id="popup-confirm-btn" class="px-5 py-2 bg-green-600 text-white text-sm font-medium rounded-xl shadow-sm hover:bg-green-700">OK</button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="overlay" class="absolute inset-0 bg-black z-40" onclick="ui.toggleSidebar()"></div>
    <div id="sidebar" class="absolute top-0 left-0 h-full w-3/4 bg-white shadow-xl flex flex-col">
        <div class="p-6 bg-gradient-to-br from-green-600 to-emerald-700 text-white">
            <h1 class="text-2xl font-extrabold mb-6">Langsung Gass</h1>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-green-600 font-bold text-2xl overflow-hidden border-4 border-white/20 shadow-inner"><i class="fa-solid fa-user" id="sidebar-avatar"></i></div>
                <div><h2 class="font-bold text-lg leading-tight" id="sidebar-username">Tamu</h2><p class="text-xs opacity-80 mt-1" id="sidebar-phone">...</p></div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto py-2">
            <button onclick="ui.openPage('history')" class="w-full flex items-center px-6 py-4 hover:bg-gray-50 text-gray-700"><i class="fa-solid fa-receipt w-8 text-center mr-3 text-green-600 text-lg"></i><span class="font-medium">Riwayat</span></button>
            <button onclick="ui.openPage('wallet')" class="w-full flex items-center px-6 py-4 hover:bg-gray-50 text-gray-700"><i class="fa-solid fa-wallet w-8 text-center mr-3 text-green-600 text-lg"></i><span class="font-medium">Dompet</span></button>
            <div class="border-t my-2 mx-6 border-gray-200"></div>
            <p class="px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Akun</p>
            <button onclick="ui.openPage('edit-profile')" class="w-full flex items-center px-6 py-3 hover:bg-gray-50 text-gray-700"><div class="w-8 flex justify-center mr-3"><i class="fa-solid fa-user-pen text-blue-600 text-lg"></i></div><span class="font-medium">Profil Penumpang</span></button>
            <button onclick="ui.openPage('edit-driver')" class="w-full flex items-center px-6 py-3 hover:bg-gray-50 text-gray-700"><div class="w-8 flex justify-center mr-3"><i class="fa-solid fa-id-card text-purple-600 text-lg"></i></div><span class="font-medium">Profil Driver</span></button>
            <div class="border-t my-2 mx-6 border-gray-200"></div>
            <button onclick="ui.logout()" class="w-full flex items-center px-6 py-3 hover:bg-red-50 text-red-600 mt-2"><i class="fa-solid fa-right-from-bracket w-8 text-center mr-3 text-lg"></i><span class="font-bold">Keluar</span></button>
        </div>
        <div class="p-4 text-center text-xs text-gray-400 border-t bg-gray-50"><span id="status-dot" class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-1"></span> <span id="status-text">Mode Aman</span></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="relative h-full flex flex-col">
        <div class="absolute top-0 left-0 w-full z-30 p-4 pt-6 flex justify-between items-start pointer-events-none">
            <button onclick="ui.toggleSidebar()" class="pointer-events-auto w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-700 active:scale-95 transition-transform"><i class="fa-solid fa-bars text-lg"></i></button>
            <button onclick="ui.openPage('wallet')" class="pointer-events-auto bg-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 active:scale-95 transition-transform"><i class="fa-solid fa-wallet text-blue-600"></i><span class="font-bold text-sm" id="header-balance">...</span></button>
        </div>
        <div id="map" class="flex-grow bg-gray-100 z-0"></div>
        <div id="main-panel" class="absolute bottom-0 left-0 w-full bg-white z-30 rounded-t-3xl shadow-[0_-5px_25px_rgba(0,0,0,0.1)] transition-all duration-300 ease-out" style="max-height: 85vh;">
            <div class="w-full flex justify-center pt-3 pb-1"><div class="w-12 h-1.5 bg-gray-200 rounded-full"></div></div>
            <!-- HOME -->
            <div id="view-home" class="p-5 pb-8">
                <h3 class="text-lg font-bold mb-5 text-gray-800" id="home-greeting">Halo!</h3>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <button onclick="ui.selectService('Motor')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 border border-green-100"><i class="fa-solid fa-motorcycle text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Motor</span></button>
                    <button onclick="ui.selectService('Mobil')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 border border-green-100"><i class="fa-solid fa-car text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Mobil</span></button>
                    <button onclick="ui.selectService('Makanan')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-500 border border-red-100"><i class="fa-solid fa-utensils text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Makan</span></button>
                    <button onclick="ui.selectService('Kirim')" class="group flex flex-col items-center gap-2 active:scale-95 transition-transform"><div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-500 border border-blue-100"><i class="fa-solid fa-box text-2xl"></i></div><span class="text-xs font-semibold text-gray-600">Kirim</span></button>
                </div>
            </div>
            <!-- BOOKING -->
            <div id="view-booking" class="p-5 pb-8 hidden">
                <div class="flex items-center mb-4"><button onclick="ui.goBack()" class="mr-4 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-sm"></i></button><h3 class="text-lg font-bold text-gray-800" id="service-title">Pesan</h3></div>
                <div class="relative pl-8 border-l-2 border-dashed border-gray-200 ml-4 space-y-5">
                    <div class="relative"><div class="absolute -left-[39px] top-2 w-5 h-5 bg-green-100 rounded-full border-4 border-white shadow-sm"></div><label class="text-xs text-gray-500 font-bold uppercase mb-1 block">Jemput</label><div class="flex gap-2"><input type="text" id="pickup-input" placeholder="Cari lokasi..." class="flex-1 bg-gray-50 border border-gray-200 p-3.5 rounded-xl text-sm font-medium"><button onclick="logic.detectLocation()" id="gps-btn" class="bg-green-50 border border-green-100 text-green-600 w-12 rounded-xl flex items-center justify-center"><i class="fa-solid fa-crosshairs"></i></button></div></div>
                    <div class="relative"><div class="absolute -left-[39px] top-2 w-5 h-5 bg-red-100 rounded-full border-4 border-white shadow-sm"></div><label class="text-xs text-gray-500 font-bold uppercase mb-1 block">Tujuan</label><input type="text" id="dest-input" placeholder="Mau ke mana?" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl text-sm font-medium"></div>
                </div>
                <div id="price-section" class="mt-6 hidden opacity-0 transition-all duration-500 transform translate-y-4">
                    <div class="flex justify-between items-center p-4 border border-green-100 bg-green-50/50 rounded-2xl mb-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-white rounded-full shadow-sm text-green-600 flex items-center justify-center"><i class="fa-solid fa-money-bill-wave"></i></div><div><p class="text-xs text-gray-500 font-medium">Estimasi</p><p class="font-bold text-gray-800 text-lg" id="price-tag">Rp 0</p></div></div><span id="distance-tag" class="text-xs bg-white border border-gray-200 px-2 py-1 rounded-lg text-gray-500 font-medium">0 km</span></div>
                    <button onclick="logic.startOrder()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.99]">Pesan Sekarang</button>
                </div>
            </div>
            <!-- SEARCHING -->
            <div id="view-searching" class="p-8 pb-12 hidden text-center flex flex-col items-center">
                <div class="relative w-32 h-32 mb-8"><div class="absolute inset-0 bg-green-400 rounded-full opacity-20 pulse-ring"></div><div class="relative w-32 h-32 bg-white rounded-full border-[6px] border-green-50 flex items-center justify-center z-10 shadow-xl"><i class="fa-solid fa-magnifying-glass text-4xl text-green-500 animate-bounce"></i></div></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Mencari Driver...</h3><button onclick="ui.cancelOrder()" class="mt-8 text-red-500 font-bold text-sm border-2 border-red-100 px-8 py-3 rounded-full hover:bg-red-50">Batalkan</button>
            </div>
            <!-- DRIVER FOUND -->
            <div id="view-driver" class="p-5 pb-6 hidden">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100"><h3 class="text-lg font-bold text-gray-800">Menuju Lokasi</h3><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">Live</span></div>
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gray-100 rounded-full overflow-hidden border-2 border-white shadow-lg shrink-0"><img src="" alt="Driver" class="w-full h-full object-cover" id="img-driver-face"></div>
                    <div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 truncate text-lg" id="lbl-driver-name">...</h4><div class="flex items-center gap-2 text-sm text-gray-500 mt-1"><span class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-xs font-bold">5.0 â˜…</span><span class="font-mono font-medium text-gray-700 bg-gray-100 px-1.5 py-0.5 rounded" id="lbl-driver-plate">...</span></div></div>
                    <div class="flex gap-2"><button onclick="ui.contactDriver()" class="w-11 h-11 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 shadow-lg active:scale-90"><i class="fa-brands fa-whatsapp text-xl"></i></button></div>
                </div>
                <button onclick="ui.finishOrder()" class="w-full bg-gray-100 text-gray-600 font-bold py-4 rounded-xl hover:bg-gray-200 border border-gray-200">Selesaikan</button>
            </div>
        </div>
    </div>

    <!-- DRIVER MODAL -->
    <div id="driver-app-modal" class="fixed bottom-4 left-4 right-4 z-[80] hidden driver-modal-enter">
        <div class="bg-gray-900 text-white rounded-3xl shadow-2xl overflow-hidden border border-gray-700 ring-4 ring-black/20">
            <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700"><div class="flex items-center gap-2"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div><span class="font-bold text-sm tracking-wide">DRIVER APP</span></div><span class="text-xs text-gray-400 font-mono">ORDER MASUK</span></div>
            <div class="p-6">
                <div class="text-center mb-6"><p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Lokasi Jemput</p><h3 class="text-lg font-bold text-white truncate px-4" id="driver-modal-customer">...</h3></div>
                <div class="flex justify-between items-center bg-gray-800/50 p-4 rounded-xl mb-6 border border-gray-700"><span class="text-sm text-gray-400">Pendapatan</span><span class="text-2xl font-bold text-green-400" id="driver-earn">Rp 0</span></div>
                <div class="flex gap-3"><button onclick="logic.rejectOrder()" class="flex-1 py-3.5 rounded-xl font-bold text-sm border border-gray-600 text-gray-400 hover:bg-gray-800">Abaikan</button><button onclick="logic.acceptOrder()" class="flex-[2] py-3.5 rounded-xl font-bold text-sm bg-green-600 text-white hover:bg-green-500 shadow-lg">TERIMA</button></div>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE PAGES -->
    <div id="page-edit-driver" class="full-page-view hidden">
        <div class="flex items-center mb-6"><button onclick="ui.closePage('page-edit-driver')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Profil Driver</h2></div>
        <div class="flex justify-between items-center bg-green-50 p-4 rounded-xl border border-green-100 mb-6"><div><h4 class="font-bold text-sm text-gray-800">Status Driver</h4><p class="text-xs text-green-600 font-medium" id="driver-status-text">Aktif</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="driver-active-toggle" class="sr-only peer" onchange="logic.toggleDriverStatus(this)"><div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label></div>
        <div class="mb-6"><label class="text-xs font-bold text-gray-500 ml-1 mb-2 block">Kendaraan</label><div class="flex gap-3"><label class="flex-1 bg-white border border-gray-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50"><input type="checkbox" class="hidden" id="check-vehicle-motor" checked><i class="fa-solid fa-motorcycle text-green-600"></i><span class="text-sm font-medium text-gray-700">Motor</span></label><label class="flex-1 bg-white border border-gray-200 p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50"><input type="checkbox" class="hidden" id="check-vehicle-mobil" checked><i class="fa-solid fa-car text-green-600"></i><span class="text-sm font-medium text-gray-700">Mobil</span></label></div></div>
        <div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 ml-1">Foto</label><div class="flex items-center gap-4 mt-2"><img id="preview-driver-photo" src="" class="w-16 h-16 rounded-full object-cover border border-gray-200 bg-gray-100"><label class="bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 cursor-pointer hover:bg-gray-200">Ubah <input type="file" class="hidden" accept="image/*" onchange="logic.handlePhotoUpload(this)"></label></div></div><div><label class="text-xs font-bold text-gray-500 ml-1">Nama</label><input type="text" id="input-driver-name" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">Plat</label><input type="text" id="input-driver-plate" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">No HP (WA)</label><input type="tel" id="input-driver-phone" class="form-input mt-1"></div><button onclick="logic.saveDriverProfile()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4 hover:bg-blue-700">Simpan Data Driver</button></div>
    </div>

    <div id="page-edit-profile" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="ui.closePage('page-edit-profile')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Profil Penumpang</h2></div><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 ml-1">Nama</label><input type="text" id="input-user-name" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">No HP</label><input type="tel" id="input-user-phone" class="form-input mt-1"></div><div><label class="text-xs font-bold text-gray-500 ml-1">Email</label><input type="email" id="input-user-email" class="form-input mt-1"></div><button onclick="logic.saveUserProfile()" class="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg mt-4 hover:bg-green-700">Simpan Data</button></div></div>
    <div id="page-wallet" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="ui.closePage('page-wallet')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex justify-center items-center"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Dompet</h2></div><div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg mb-6"><p class="text-sm opacity-80">Saldo</p><h1 class="text-3xl font-bold mt-1" id="wallet-balance-page">...</h1><button onclick="ui.openTopUpModal()" class="mt-4 bg-white text-blue-600 px-4 py-2 rounded-lg font-bold text-sm w-full">Isi Saldo</button></div></div>
    <div id="page-history" class="full-page-view hidden"><div class="flex items-center mb-6"><button onclick="ui.closePage('page-history')" class="mr-4 w-8 h-8 bg-gray-100 rounded-full flex justify-center items-center"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Riwayat</h2></div><div id="history-list" class="space-y-3 text-center text-gray-400 mt-10">Belum ada riwayat</div></div>

    <!-- LOGIC SCRIPT (SAFE MODE) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. LOCAL DB (Anti-Fail) ---
        const db = {
            user: JSON.parse(localStorage.getItem('gg_user')) || { name: "User Baru", phone: "", email: "", balance: 50000 },
            driver: JSON.parse(localStorage.getItem('gg_driver')) || { 
                name: "Budi Santoso", plate: "B 1234 XYZ", phone: "", photo: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", 
                active: true, vehicleTypes: ['Motor', 'Mobil'] 
            },
            save: function() {
                try {
                    localStorage.setItem('gg_user', JSON.stringify(this.user));
                    localStorage.setItem('gg_driver', JSON.stringify(this.driver));
                } catch(e) { console.log("Storage full"); }
            }
        };

        // --- 2. UI LOGIC ---
        const ui = {
            toggleSidebar: () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); },
            openPage: (id) => { ui.toggleSidebar(); document.getElementById(id).classList.add('active'); document.getElementById(id).classList.remove('hidden'); },
            closePage: (id) => { document.getElementById(id).classList.remove('active'); setTimeout(() => document.getElementById(id).classList.add('hidden'), 300); },
            switchView: (id) => { ['view-home','view-booking','view-searching','view-driver'].forEach(v => document.getElementById(v).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); },
            selectService: (t) => { logic.serviceType = t; document.getElementById('service-title').innerText = t; ui.switchView('booking'); },
            goBack: () => ui.switchView('home'),
            cancelOrder: () => { ui.switchView('home'); ui.toast("Dibatalkan"); },
            finishOrder: () => { ui.switchView('home'); ui.toast("Selesai"); },
            contactDriver: () => window.open(`https://wa.me/${db.driver.phone}`, '_blank'),
            logout: () => { if(confirm("Keluar?")) location.reload(); },
            toast: (msg) => { const t = document.createElement('div'); t.className = 'toast show'; t.innerHTML = `<span>${msg}</span>`; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 3000); },
            openTopUpModal: () => { const amt = prompt("Jumlah:", "50000"); if(amt) { db.user.balance += parseInt(amt); db.save(); logic.refreshUI(); } },
            closePopup: () => document.getElementById('custom-popup-overlay').classList.remove('show')
        };

        // --- 3. BUSINESS LOGIC ---
        const logic = {
            serviceType: 'Motor',
            init: () => {
                logic.refreshUI();
                // Map
                setTimeout(() => {
                    if(document.getElementById('map')) {
                        const map = L.map('map', {zoomControl: false}).setView([-6.175392, 106.827153], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        L.marker([-6.175392, 106.827153]).addTo(map);
                    }
                    document.getElementById('splash-screen').classList.add('fade-out');
                    setTimeout(() => document.getElementById('splash-screen').remove(), 500);
                }, 800);
                // Prefill
                if(document.getElementById('input-user-name')) {
                    document.getElementById('input-user-name').value = db.user.name;
                    document.getElementById('input-user-phone').value = db.user.phone;
                    document.getElementById('input-user-email').value = db.user.email;
                    document.getElementById('input-driver-name').value = db.driver.name;
                    document.getElementById('input-driver-plate').value = db.driver.plate;
                    document.getElementById('input-driver-phone').value = db.driver.phone;
                    document.getElementById('preview-driver-photo').src = db.driver.photo;
                    document.getElementById('driver-active-toggle').checked = db.driver.active;
                    document.getElementById('check-vehicle-motor').checked = db.driver.vehicleTypes.includes('Motor');
                    document.getElementById('check-vehicle-mobil').checked = db.driver.vehicleTypes.includes('Mobil');
                }
            },

            refreshUI: () => {
                // INSTANT NAME UPDATE
                if(document.getElementById('sidebar-username')) document.getElementById('sidebar-username').innerText = db.user.name;
                if(document.getElementById('home-greeting')) document.getElementById('home-greeting').innerText = `Halo, ${db.user.name.split(' ')[0]}!`;
                
                const bal = `Rp ${db.user.balance.toLocaleString('id-ID')}`;
                if(document.getElementById('header-balance')) document.getElementById('header-balance').innerText = bal;
                if(document.getElementById('wallet-balance-page')) document.getElementById('wallet-balance-page').innerText = bal;
                
                const st = document.getElementById('driver-status-text');
                if(st) { st.innerText = db.driver.active ? "Aktif" : "Off"; st.className = db.driver.active ? "text-xs text-green-600 font-bold" : "text-xs text-gray-500 font-bold"; }
            },

            saveUserProfile: () => {
                db.user.name = document.getElementById('input-user-name').value;
                db.user.phone = document.getElementById('input-user-phone').value;
                db.user.email = document.getElementById('input-user-email').value;
                db.save();
                logic.refreshUI();
                ui.closePage('page-edit-profile');
                ui.toast("Tersimpan!");
                if(window.cloudSyncUser) window.cloudSyncUser(); // Try sync
            },

            saveDriverProfile: () => {
                db.driver.name = document.getElementById('input-driver-name').value;
                db.driver.plate = document.getElementById('input-driver-plate').value;
                db.driver.phone = document.getElementById('input-driver-phone').value;
                db.driver.photo = document.getElementById('preview-driver-photo').src;
                const types = [];
                if(document.getElementById('check-vehicle-motor').checked) types.push('Motor');
                if(document.getElementById('check-vehicle-mobil').checked) types.push('Mobil');
                db.driver.vehicleTypes = types;
                db.save();
                logic.refreshUI();
                ui.closePage('page-edit-driver');
                ui.toast("Driver Tersimpan");
                if(window.cloudSyncDriver) window.cloudSyncDriver();
            },

            toggleDriverStatus: (el) => {
                db.driver.active = el.checked;
                db.save();
                logic.refreshUI();
                if(window.cloudSyncDriver) window.cloudSyncDriver();
            },

            handlePhotoUpload: (input) => {
                if(input.files[0]) {
                    const r = new FileReader();
                    r.onload = (e) => { document.getElementById('preview-driver-photo').src = e.target.result; };
                    r.readAsDataURL(input.files[0]);
                }
            },

            detectLocation: () => {
                const btn = document.getElementById('gps-btn'); btn.innerHTML = '...';
                setTimeout(() => {
                    document.getElementById('pickup-input').value = "Monas (Lokasi Saya)";
                    btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
                    ui.toast("Lokasi Ditemukan");
                }, 1000);
            },

            startOrder: () => {
                const p = document.getElementById('pickup-input').value;
                const d = document.getElementById('dest-input').value;
                if(!p || !d) { ui.toast("Isi lokasi dulu"); return; }
                ui.switchView('searching');
                
                // Priority: Cloud -> Local Simulation
                if(window.cloudCreateOrder) window.cloudCreateOrder(p, d, logic.serviceType);
                else setTimeout(() => {
                    // Fallback Simulation
                    if(db.driver.active) {
                        document.getElementById('driver-app-modal').classList.remove('hidden');
                        document.getElementById('driver-app-modal').classList.add('driver-modal-active');
                        document.getElementById('driver-modal-customer').innerText = p;
                        document.getElementById('driver-earn').innerText = "Rp 15.000";
                    } else {
                        ui.toast("Tidak ada driver"); ui.cancelOrder();
                    }
                }, 2000);
            },

            acceptOrder: () => {
                document.getElementById('driver-app-modal').classList.remove('driver-modal-active');
                setTimeout(() => document.getElementById('driver-app-modal').classList.add('hidden'), 300);
                
                ui.switchView('driver');
                document.getElementById('lbl-driver-name').innerText = db.driver.name;
                document.getElementById('lbl-driver-plate').innerText = db.driver.plate;
                document.getElementById('img-driver-face').src = db.driver.photo;
                window.currentDriverPhone = db.driver.phone;
                
                if(window.cloudAcceptOrder) window.cloudAcceptOrder();
            },
            
            rejectOrder: () => {
                 document.getElementById('driver-app-modal').classList.remove('driver-modal-active');
                 setTimeout(() => document.getElementById('driver-app-modal').classList.add('hidden'), 300);
            }
        };

        logic.init();
    </script>

    <!-- FIREBASE SYNC (Optional Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAfRv6lA2U2ntFu-jgzpm5uoBxSkPyjVC4", authDomain: "gotransite.firebaseapp.com", projectId: "gotransite", storageBucket: "gotransite.firebasestorage.app", messagingSenderId: "991886146654", appId: "1:991886146654:web:73648a5a791c322d20c8cf", measurementId: "G-JVGKB93E8K" };

        let db_cloud, uid, incomingOrderId;

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db_cloud = getFirestore(app);
            
            onAuthStateChanged(auth, (u) => {
                if(u) {
                    uid = u.uid;
                    document.getElementById('splash-text').innerText = "Online";
                    // Start Listening
                    if(db.driver.active) startListener();
                } else signInAnonymously(auth);
            });
        } catch(e) { console.log("Offline"); }

        // Global Hooks
        window.cloudSyncUser = async () => { if(uid) await setDoc(doc(db_cloud, "users", uid), db.user, {merge:true}); };
        window.cloudSyncDriver = async () => { 
            if(uid) {
                await setDoc(doc(db_cloud, "users", uid, "settings", "driver_profile"), db.driver, {merge:true});
                if(db.driver.active) startListener();
            }
        };
        window.cloudCreateOrder = async (p, d, type) => {
            if(!uid) return;
            try {
                const ref = await addDoc(collection(db_cloud, "orders"), {
                    userId: uid, pickup: p, dest: d, serviceType: type,
                    price: 15000, status: "searching", createdAt: new Date()
                });
                // Self-Notify for Demo
                if(db.driver.active && db.driver.vehicleTypes.includes(type)) {
                    setTimeout(() => {
                        incomingOrderId = ref.id;
                        document.getElementById('driver-app-modal').classList.remove('hidden');
                        document.getElementById('driver-app-modal').classList.add('driver-modal-active');
                        document.getElementById('driver-modal-customer').innerText = p;
                        document.getElementById('driver-earn').innerText = "Rp 15.000";
                    }, 1000);
                }
                // Listen for accept
                onSnapshot(doc(db_cloud, "orders", ref.id), (snap) => {
                    const data = snap.data();
                    if(data && data.status === "accepted") {
                         document.getElementById('lbl-driver-name').innerText = data.driverName;
                         document.getElementById('lbl-driver-plate').innerText = data.driverPlate;
                         ui.switchView('driver');
                         document.getElementById('driver-app-modal').classList.remove('driver-modal-active');
                         document.getElementById('driver-app-modal').classList.add('hidden');
                    }
                });
            } catch(e) { }
        };
        window.cloudAcceptOrder = async () => {
            if(incomingOrderId) {
                await updateDoc(doc(db_cloud, "orders", incomingOrderId), {
                    status: "accepted", driverName: db.driver.name, driverPlate: db.driver.plate
                });
            }
        };
        function startListener() {
            const q = query(collection(db_cloud, "orders"), where("status", "==", "searching"), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snap) => {
                snap.docChanges().forEach((c) => {
                    if(c.type === "added" && c.doc.data().userId !== uid) {
                        const d = c.doc.data();
                        if(db.driver.vehicleTypes.includes(d.serviceType)) {
                            incomingOrderId = c.doc.id;
                            document.getElementById('driver-app-modal').classList.remove('hidden');
                            document.getElementById('driver-app-modal').classList.add('driver-modal-active');
                            document.getElementById('driver-modal-customer').innerText = d.pickup;
                            document.getElementById('driver-earn').innerText = "Rp 15.000";
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>