import React, { useState, useEffect, useRef } from 'react';
import { 
  Bike, 
  User, 
  MapPin, 
  Home, 
  History, 
  LogOut, 
  PlusCircle, 
  CheckCircle, 
  XCircle,
  Menu,
  LayoutDashboard,
  Users,
  Navigation,
  Wallet,
  Phone,
  MessageCircle,
  Store,    
  Package,  
  Calculator, 
  Map,
  Search,    
  Loader2,
  Navigation2,
  Utensils, 
  Shirt,
  PhoneCall,
  ArrowRight,
  Lock, 
  Eye,
  EyeOff,
  ShieldAlert,
  KeyRound,
  Info,
  ShieldCheck,
  UserCircle,
  FileText,
  UserCog, 
  UserX,   
  UserCheck,
  Power, 
  Coffee,
  Car, 
  Truck,
  Flag,
  Trash2,
  X, 
  Radar,
  Banknote, 
  CreditCard,
  Calendar,
  ChevronLeft, 
  ChevronRight,
  CheckSquare,
  Download,
  Shield,
  Clock,
  Headphones,
  ShoppingBag,
  ListPlus, 
  Trash,
  TrendingUp // Icon Laporan
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  doc, 
  getDoc, 
  getDocs, 
  query,   
  where,   
  setDoc, 
  onSnapshot,
  writeBatch,
  deleteDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';

// --- Firebase Config ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "AIzaSyAfRv6lA2U2ntFu-jgzpm5uoBxSkPyjVC4", 
      authDomain: "gotransite.firebaseapp.com",
      projectId: "gotransite",
      storageBucket: "gotransite.firebasestorage.app",
      messagingSenderId: "991886146654",
      appId: "1:991886146654:web:87900e39e1e3421320c8cf",
      measurementId: "G-0SMEJZY8B6"
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants ---
const DEBOUNCE_DELAY = 1000; 
const ADMIN_SECRET_PIN = '888888'; 
const MASTER_RESET_CODE = '888888'; 
const ADMIN_WA_NUMBER = '6281311314203'; 
const ADMIN_FEE_PERCENTAGE = 0.15; 
const ITEMS_PER_PAGE = 5; 
const OWNER_SECRET_PIN = '769108';

// --- Helper Functions ---
const formatWA = (number) => {
  if (!number) return '';
  let cleanNum = number.replace(/\D/g, '');
  if (cleanNum.startsWith('0')) {
    cleanNum = '62' + cleanNum.slice(1);
  }
  return cleanNum;
};

const sanitizeId = (text) => {
  return text.replace(/[^a-zA-Z0-9]/g, '');
};

const getRoadDistance = async (lat1, lng1, lat2, lng2) => {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=false`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
      const distanceMeters = data.routes[0].distance;
      return (distanceMeters / 1000).toFixed(1); 
    }
    return null;
  } catch (error) {
    return null; 
  }
};

const calculateDistanceFallback = (lat1, lon1, lat2, lon2) => {
  const R = 6371; 
  const dLat = (lat2 - lat1) * (Math.PI / 180);
  const dLon = (lon2 - lon1) * (Math.PI / 180);
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return (R * c * 1.4).toFixed(1); 
};

// --- Sub-Component: Location Search Input ---
const LocationSearchInput = ({ label, placeholder, onSelect, initialValue, readOnly = false }) => {
  const [query, setQuery] = useState(initialValue || '');
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const wrapperRef = useRef(null);

  useEffect(() => {
      setQuery(initialValue || '');
  }, [initialValue]);

  useEffect(() => {
    if (readOnly) return; 
    const timer = setTimeout(async () => {
      if (query && query.length > 2 && isOpen) {
        setIsLoading(true);
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=id&limit=10&addressdetails=1`, {
             headers: { 'User-Agent': 'OjekWargaApp/2.0' }
          });
          const data = await response.json();
          setResults(data || []);
        } catch (e) {
          console.error(e);
          setResults([]);
        } finally {
          setIsLoading(false);
        }
      }
    }, DEBOUNCE_DELAY);
    return () => clearTimeout(timer);
  }, [query, isOpen, readOnly]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [wrapperRef]);

  const handleSelect = (item) => {
    setQuery(item.display_name); 
    setIsOpen(false);
    onSelect({
      name: item.display_name,
      lat: parseFloat(item.lat),
      lng: parseFloat(item.lon)
    });
  };

  return (
    <div className="relative mb-4" ref={wrapperRef}>
      <label className="block text-gray-700 font-bold mb-1 text-sm">{label}</label>
      <div className="relative">
        <MapPin size={16} className="absolute left-3 top-3.5 text-gray-400" />
        <input
          type="text"
          value={query || ''}
          onChange={(e) => { setQuery(e.target.value); setIsOpen(true); }}
          onFocus={() => !readOnly && setIsOpen(true)}
          placeholder={placeholder}
          readOnly={readOnly}
          className={`w-full pl-10 p-3 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none transition ${readOnly ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
        />
        {isLoading && <Loader2 size={16} className="absolute right-3 top-3.5 text-blue-500 animate-spin" />}
      </div>
      {!readOnly && (
          <p className="text-[10px] text-gray-400 mt-1 ml-1">Tips: Masukkan "Nama Jalan, Kelurahan" atau "Gang, Kota"</p>
      )}
      {isOpen && results.length > 0 && !readOnly && (
        <div className="absolute z-50 w-full bg-white mt-1 rounded-xl shadow-xl border border-gray-100 max-h-60 overflow-y-auto">
          {results.map((item, idx) => (
            <button
              key={idx}
              type="button"
              onClick={() => handleSelect(item)}
              className="w-full text-left p-3 hover:bg-blue-50 border-b border-gray-50 text-xs text-gray-700 flex items-start transition"
            >
              <MapPin size={14} className="mt-0.5 mr-2 flex-shrink-0 text-blue-400"/>
              <span className="line-clamp-2">{item.display_name}</span>
            </button>
          ))}
        </div>
      )}
    </div>
  );
};

// --- Main Component ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-2xl shadow-lg p-6 ${className}`}>
    {children}
  </div>
);

const Badge = ({ status, type }) => {
  const colors = {
    pending: 'bg-yellow-100 text-yellow-700 border-yellow-300',
    accepted: 'bg-blue-100 text-blue-700 border-blue-300',
    completed: 'bg-green-100 text-green-700 border-green-300',
    cancelled: 'bg-red-100 text-red-700 border-red-300',
  };
  const labels = { pending: 'Mencari', accepted: 'Proses', completed: 'Selesai', cancelled: 'Batal' };
  
  let typeBadge = null;
  if (type === 'delivery') typeBadge = <span className="px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200 flex items-center"><Package size={12} className="mr-1"/> Paket</span>;
  if (type === 'food') typeBadge = <span className="px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200 flex items-center"><Utensils size={12} className="mr-1"/> Makanan</span>;
  if (type === 'laundry') typeBadge = <span className="px-2 py-1 rounded-full text-xs font-bold bg-cyan-100 text-cyan-700 border border-cyan-200 flex items-center"><Shirt size={12} className="mr-1"/> Laundry</span>;
  if (type === 'ride_car') typeBadge = <span className="px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200 flex items-center"><Car size={12} className="mr-1"/> Mobil</span>;
  if (type === 'ride_pickup') typeBadge = <span className="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-700 border border-slate-200 flex items-center"><Truck size={12} className="mr-1"/> Pickup</span>;

  return (
    <div className="flex gap-2">
      <span className={`px-3 py-1 rounded-full text-xs font-bold border ${colors[status] || 'bg-gray-100'}`}>{labels[status] || status}</span>
      {typeBadge}
    </div>
  );
};

export default function App() {
  const [firebaseUser, setFirebaseUser] = useState(null);
  const [currentUser, setCurrentUser] = useState(() => {
    const saved = localStorage.getItem('ojekWargaUser');
    return saved ? JSON.parse(saved) : null;
  });
  const [appState, setAppState] = useState(() => localStorage.getItem('ojekWargaUser') ? 'dashboard' : 'landing');
  const [selectedRole, setSelectedRole] = useState(null); 
  const [orders, setOrders] = useState([]);
  const [activeMenu, setActiveMenu] = useState('dashboard');
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // Pagination State
  const [currentPage, setCurrentPage] = useState(1);

  // Form Global
  const [regName, setRegName] = useState('');
  const [regWA, setRegWA] = useState('');
  const [regPlate, setRegPlate] = useState('');
  const [regMotor, setRegMotor] = useState('');
  const [regAddress, setRegAddress] = useState(''); 
  const [regPin, setRegPin] = useState(''); 
  const [regMerchantName, setRegMerchantName] = useState(''); 
  const [regVehicleType, setRegVehicleType] = useState('Motor');
  const [inputPin, setInputPin] = useState(''); 
  const [showPin, setShowPin] = useState(false);

  // Driver Status
  const [isDriverOnline, setIsDriverOnline] = useState(true); 

  // Forgot PIN State
  const [otp, setOtp] = useState('');
  const [resetStep, setResetStep] = useState('request'); 

  const [isCheckingUser, setIsCheckingUser] = useState(false);
  const [foundUser, setFoundUser] = useState(null); 

  // Manage Users State
  const [driversList, setDriversList] = useState([]);
  const [loadingDrivers, setLoadingDrivers] = useState(false);
  const [processingDriverId, setProcessingDriverId] = useState(null); 
  
  // Merchant List & Menu State
  const [merchantList, setMerchantList] = useState([]);
  const [merchantMenu, setMerchantMenu] = useState([]); 
  const [cart, setCart] = useState({}); 
  const [newItemName, setNewItemName] = useState(''); 
  const [newItemPrice, setNewItemPrice] = useState('');

  // Finance & Owner PIN State
  const [isFinanceUnlocked, setIsFinanceUnlocked] = useState(false);
  const [showFinancePinModal, setShowFinancePinModal] = useState(false);
  const [financePinInput, setFinancePinInput] = useState('');
  const [financeTab, setFinanceTab] = useState('driver'); // 'driver' or 'merchant'

  // Order State
  const [pickupLoc, setPickupLoc] = useState(null); 
  const [dropoffLoc, setDropoffLoc] = useState(null); 
  const [price, setPrice] = useState(''); 
  const [itemCost, setItemCost] = useState(0); 
  const [distance, setDistance] = useState(''); 
  const [orderDetail, setOrderDetail] = useState(''); 
  const [isCalculating, setIsCalculating] = useState(false);
  const [selectedVehicle, setSelectedVehicle] = useState('Motor');
  
  const [selectedMerchantId, setSelectedMerchantId] = useState('');

  // UI State
  const [processingOrder, setProcessingOrder] = useState(null); 
  const [completingOrder, setCompletingOrder] = useState(null); 
  const [trackingOrderId, setTrackingOrderId] = useState(null); 
  const [markingPaid, setMarkingPaid] = useState(null); 

  // --- Initialize & Reset ---
  useEffect(() => {
    setPickupLoc(null);
    setDropoffLoc(null);
    setPrice('');
    setDistance('');
    setOrderDetail('');
    setSelectedMerchantId('');
    setCart({});
    setItemCost(0);
    setIsCalculating(false);
    setProcessingOrder(null);
    setTrackingOrderId(null);
    if (activeMenu === 'pesan') setSelectedVehicle('Motor');
  }, [activeMenu]);

  // --- Firebase ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setFirebaseUser);
  }, []);

  useEffect(() => {
    if (!firebaseUser) return;
    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    return onSnapshot(ordersRef, (snapshot) => {
      const loadedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      loadedOrders.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
      setOrders(loadedOrders);
    });
  }, [firebaseUser]);

  // --- FETCH MERCHANTS ---
  useEffect(() => {
    if ((activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') && currentUser) {
        const fetchMerchants = async () => {
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles'), where('role', '==', 'merchant'));
                const querySnapshot = await getDocs(q);
                const merchants = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setMerchantList(merchants);
            } catch (err) {
                console.error("Error fetching merchants:", err);
            }
        };
        fetchMerchants();
    }
  }, [activeMenu, currentUser]);

  // --- FETCH MERCHANT MENU ---
  useEffect(() => {
      if (selectedMerchantId) {
          const fetchMenu = async () => {
              const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'products'), where('merchantId', '==', selectedMerchantId));
              const querySnapshot = await getDocs(q);
              const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMerchantMenu(items);
              setCart({}); 
          };
          fetchMenu();
      }
  }, [selectedMerchantId]);

  // --- FETCH MY MENU (Merchant) ---
  useEffect(() => {
      if (activeMenu === 'manage_menu' && currentUser?.role === 'merchant') {
          const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'products'), where('merchantId', '==', currentUser.wa));
          const unsubscribe = onSnapshot(q, (querySnapshot) => {
              const items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMerchantMenu(items);
          });
          return () => unsubscribe();
      }
  }, [activeMenu, currentUser]);


  // Sync Driver Online Status
  useEffect(() => {
    if (currentUser && currentUser.role === 'driver') {
       setIsDriverOnline(currentUser.isOnline !== false);
    }
  }, [currentUser]);

  // --- MERCHANT: ADD MENU ---
  const addMenuItem = async (e) => {
      e.preventDefault();
      if (!newItemName || !newItemPrice) return;
      try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
              merchantId: currentUser.wa, 
              name: newItemName,
              price: parseInt(newItemPrice),
              createdAt: new Date().toISOString()
          });
          setNewItemName('');
          setNewItemPrice('');
      } catch (err) {
          console.error(err);
          alert("Gagal menambah menu.");
      }
  };

  const deleteMenuItem = async (itemId) => {
      if (!window.confirm("Hapus menu ini?")) return;
      try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', itemId));
      } catch (err) { console.error(err); }
  };

  const updateCart = (itemId, delta) => {
      setCart(prev => {
          const currentQty = prev[itemId] || 0;
          const newQty = Math.max(0, currentQty + delta);
          const newCart = { ...prev, [itemId]: newQty };
          if (newQty === 0) delete newCart[itemId];
          return newCart;
      });
  };

  useEffect(() => {
      if (activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') {
          let total = 0;
          let details = [];
          merchantMenu.forEach(item => {
              const qty = cart[item.id] || 0;
              if (qty > 0) {
                  const price = item.price || 0; 
                  total += price * qty;
                  details.push(`${qty}x ${item.name}`);
              }
          });
          setItemCost(total);
          if (details.length > 0) setOrderDetail(details.join(", "));
          else setOrderDetail('');
      }
  }, [cart, merchantMenu, activeMenu]);


  // --- ADMIN: LOAD DRIVERS ---
  useEffect(() => {
    if (activeMenu === 'manage_drivers' && currentUser?.role === 'user') {
        loadDrivers();
    }
  }, [activeMenu]);

  const loadDrivers = async () => {
    setLoadingDrivers(true);
    try {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles'), where('role', '==', 'driver'));
        const querySnapshot = await getDocs(q);
        const drivers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setDriversList(drivers);
    } catch (err) {
        console.error(err);
    } finally {
        setLoadingDrivers(false);
    }
  };

  const toggleOnlineStatus = async () => {
    if (!currentUser) return;
    const newStatus = !isDriverOnline;
    setIsDriverOnline(newStatus);
    const userId = sanitizeId(currentUser.wa);
    try {
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
        await updateDoc(userRef, { isOnline: newStatus });
        const updatedUser = { ...currentUser, isOnline: newStatus };
        setCurrentUser(updatedUser);
        localStorage.setItem('ojekWargaUser', JSON.stringify(updatedUser));
    } catch (err) {
        setIsDriverOnline(!newStatus);
        alert("Gagal mengubah status.");
    }
  };

  const toggleDriverStatus = async (driverId, currentStatus) => {
    setProcessingDriverId(driverId); 
    const newStatus = currentStatus === 'suspended' ? 'active' : 'suspended';
    try {
        const driverRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', driverId);
        await updateDoc(driverRef, { status: newStatus });
        setDriversList(prev => prev.map(d => d.id === driverId ? { ...d, status: newStatus } : d));
    } catch (err) {
        alert("Gagal mengubah status: " + err.message);
    } finally {
        setProcessingDriverId(null);
    }
  };

  // --- ADMIN: MARK DRIVER PAID ---
  const markAsPaid = async (rowKey, orderIds) => {
      setMarkingPaid(rowKey);
      try {
          const batch = writeBatch(db);
          orderIds.forEach(id => {
              const ref = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
              batch.update(ref, { isPaidOut: true });
          });
          await batch.commit();
      } catch (err) {
          console.error(err);
          alert("Gagal update status pembayaran.");
      } finally {
          setMarkingPaid(null);
      }
  };

  // --- ADMIN: MARK MERCHANT PAID (NEW) ---
  const markMerchantAsPaid = async (rowKey, orderIds) => {
      setMarkingPaid(rowKey);
      try {
          const batch = writeBatch(db);
          orderIds.forEach(id => {
              const ref = doc(db, 'artifacts', appId, 'public', 'data', 'orders', id);
              batch.update(ref, { isMerchantPaid: true });
          });
          await batch.commit();
      } catch (err) {
          console.error(err);
          alert("Gagal update status pembayaran merchant.");
      } finally {
          setMarkingPaid(null);
      }
  };

  const getMyOrders = () => {
    if (!currentUser) return [];
    if (currentUser.role === 'user') return orders; 
    return orders.filter(order => {
        if (currentUser.role === 'driver') return order.driverWA === currentUser.wa;
        // For merchant, check if order contains merchant items (linked by merchantName)
        // NOTE: We used merchantName to link. Ideally ID, but name is what we saved.
        if (currentUser.role === 'merchant') return order.merchantName === currentUser.merchantName;
        return order.customerWA === currentUser.wa;
    });
  };

  // --- Logic ---
  const handleRoleSelect = (role) => {
    setSelectedRole(role);
    if (role === 'user') {
      setAppState('admin_login'); 
      setInputPin('');
    } else {
      setAppState('check_user');
      setRegWA('');
      setFoundUser(null);
      setInputPin('');
    }
  };

  const handleAdminLogin = (e) => {
    e.preventDefault();
    if (inputPin === ADMIN_SECRET_PIN) {
        const adminUser = { name: 'Super Admin', role: 'user', wa: '000' };
        localStorage.setItem('ojekWargaUser', JSON.stringify(adminUser));
        setCurrentUser(adminUser);
        setAppState('dashboard');
    } else {
        alert("PIN Salah!");
        setInputPin('');
    }
  };

  // --- OWNER PIN LOGIC ---
  const handleFinanceMenuClick = () => {
    if (isFinanceUnlocked) {
        setActiveMenu('financials');
    } else {
        setShowFinancePinModal(true);
        setIsMobileMenuOpen(false); 
    }
  };

  const verifyFinancePin = (e) => {
      e.preventDefault();
      if (financePinInput === OWNER_SECRET_PIN) {
          setIsFinanceUnlocked(true);
          setShowFinancePinModal(false);
          setFinancePinInput('');
          setActiveMenu('financials');
      } else {
          alert("PIN Owner Salah! Akses Ditolak.");
          setFinancePinInput('');
      }
  };

  const checkUserExists = async (e) => {
    e.preventDefault();
    if (!regWA) return alert("Masukkan nomor WhatsApp");
    setIsCheckingUser(true);
    const userId = sanitizeId(regWA); 
    try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const userData = docSnap.data();
            if (userData.status === 'suspended') {
                alert("AKUN DINONAKTIFKAN. Hubungi Admin.");
                setAppState('landing');
                setIsCheckingUser(false);
                return;
            }
            if (userData.role === selectedRole) {
                setFoundUser(userData);
                setAppState('login_pin'); 
            } else {
                alert(`Nomor ini terdaftar sebagai ${userData.role}.`);
                setAppState('landing');
            }
        } else {
            setAppState('register');
        }
    } catch (error) {
        alert("Gagal koneksi.");
    } finally {
        setIsCheckingUser(false);
    }
  };

  const handleVerifyPin = (e) => {
    e.preventDefault();
    if (inputPin === foundUser.pin) {
        localStorage.setItem('ojekWargaUser', JSON.stringify(foundUser));
        setCurrentUser(foundUser);
        setAppState('dashboard');
    } else {
        alert("PIN Salah!");
        setInputPin('');
    }
  };

  const handleForgotPinRequest = () => {
    setResetStep('verify');
    setAppState('forgot_pin');
  };

  const handleVerifyOtpAndReset = async (e) => {
    e.preventDefault();
    if (otp !== MASTER_RESET_CODE) return alert("Kode Otorisasi Salah!");
    if (regPin.length < 4) return alert("PIN Baru minimal 4 angka");
    const userId = sanitizeId(foundUser.wa);
    try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
        await updateDoc(docRef, { pin: regPin });
        alert("Sukses! PIN Baru disimpan.");
        const updatedUser = { ...foundUser, pin: regPin };
        setFoundUser(updatedUser);
        setAppState('login_pin');
        setInputPin('');
        setOtp('');
        setRegPin('');
    } catch (err) {
        alert("Gagal update PIN.");
    }
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    if (!regName || !regWA || !regPin || !regAddress) return alert('Semua data wajib diisi!');
    if (regPin.length < 4) return alert('PIN minimal 4 angka');
    
    if (selectedRole === 'merchant' && !regMerchantName) return alert('Nama Merchant/Toko wajib diisi!');

    const newUser = { 
        role: selectedRole, 
        name: regName, 
        wa: regWA, 
        pin: regPin, 
        address: regAddress, 
        plate: regPlate || '', 
        motor: regMotor || '', 
        vehicleType: selectedRole === 'driver' ? regVehicleType : '',
        merchantName: selectedRole === 'merchant' ? regMerchantName : '',
        shopAddress: selectedRole === 'merchant' ? regAddress : '',
        status: 'active', 
        isOnline: true, 
        joinedAt: new Date().toISOString()
    };
    const userId = sanitizeId(regWA);
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId), newUser);
        localStorage.setItem('ojekWargaUser', JSON.stringify(newUser));
        setCurrentUser(newUser);
        setAppState('dashboard');
    } catch (error) {
        alert("Gagal daftar.");
    }
  };

  // --- HANDLE MERCHANT SELECTION & AUTO ADDRESS ---
  const handleMerchantSelect = async (e) => {
      const merchantId = e.target.value;
      setSelectedMerchantId(merchantId);
      setCart({}); 
      setOrderDetail('');
      setItemCost(0);
      
      if (merchantId) {
          const merchant = merchantList.find(m => m.id === merchantId);
          if (merchant) {
              // Use merchant address for pickup
              const address = merchant.shopAddress || merchant.address; 
              const coords = await getCoordinates(address);
              
              setPickupLoc({
                  name: address, 
                  lat: coords ? coords.lat : -6.200000, 
                  lng: coords ? coords.lng : 106.816666
              });
          }
      } else {
          setPickupLoc(null);
      }
  };

  // --- CALCULATION LOGIC ---
  const updatePriceFromDistance = (dist, vehicle = selectedVehicle) => {
    setDistance(dist);
    if (dist && dist > 0) {
      const d = parseFloat(dist);
      let total = 0;
      
      let baseFare = 6000;
      let perKm = 1600;

      if (activeMenu === 'pesan' && vehicle === 'Mobil') {
          baseFare = 15000;
          perKm = 3000;
      }
      if (activeMenu === 'pesan' && vehicle === 'Mobil Pickup') {
          baseFare = 60000;
          perKm = 5000;
      }

      if (d <= 1) {
         total = baseFare;
      } else {
         total = baseFare + ((d - 1) * perKm);
      }

      const roundedPrice = Math.ceil(total / 500) * 500; 
      setPrice(roundedPrice);
    } else {
      setPrice('');
    }
  };

  useEffect(() => {
      if (distance) {
          updatePriceFromDistance(distance, selectedVehicle);
      }
  }, [selectedVehicle]);

  useEffect(() => {
    const calculate = async () => {
      if (pickupLoc && dropoffLoc) {
        setIsCalculating(true);
        let dist = await getRoadDistance(pickupLoc.lat, pickupLoc.lng, dropoffLoc.lat, dropoffLoc.lng);
        if (!dist) {
           dist = calculateDistanceFallback(pickupLoc.lat, pickupLoc.lng, dropoffLoc.lat, dropoffLoc.lng);
        }
        updatePriceFromDistance(dist, selectedVehicle);
        setIsCalculating(false);
      }
    };
    calculate();
  }, [pickupLoc, dropoffLoc]);

  const addOrder = async (e) => {
    e.preventDefault();
    if (!firebaseUser) return alert("Koneksi error...");
    if (!price || !distance) return alert("Pilih lokasi dengan benar.");
    if ((activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') && !orderDetail) return alert("Mohon pilih menu/item terlebih dahulu.");

    let orderType = 'ride';
    if (currentUser.role === 'merchant') orderType = 'delivery';
    if (activeMenu === 'pesan_makanan') orderType = 'food';
    if (activeMenu === 'pesan_laundry') orderType = 'laundry';
    if (activeMenu === 'pesan' && selectedVehicle === 'Mobil') orderType = 'ride_car'; 
    if (activeMenu === 'pesan' && selectedVehicle === 'Mobil Pickup') orderType = 'ride_pickup';
    
    let targetMerchantName = null;
    if ((activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') && selectedMerchantId) {
        const m = merchantList.find(x => x.id === selectedMerchantId);
        if(m) targetMerchantName = m.merchantName;
    }

    try {
      const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
      const docRef = await addDoc(ordersRef, {
        customer: currentUser.name, 
        customerWA: currentUser.wa, 
        merchantName: currentUser.role === 'merchant' ? currentUser.merchantName : targetMerchantName, 
        pickup: pickupLoc.name,
        dropoff: dropoffLoc.name,
        pickupLat: pickupLoc.lat, pickupLng: pickupLoc.lng,
        dropoffLat: dropoffLoc.lat, dropoffLng: dropoffLoc.lng,
        price: parseInt(price),
        itemCost: parseInt(itemCost || 0), 
        distance: parseFloat(distance),
        status: 'pending',
        type: orderType,
        orderDetail: orderDetail || null, 
        createdAt: new Date().toISOString(), 
        date: new Date().toLocaleString('id-ID'), 
        driverName: null, driverWA: null, driverPlate: null, driverMotor: null, driverVehicle: null,
        isPaidOut: false,
        isMerchantPaid: false // New Field for Merchant Payment Status
      });

      setPickupLoc(null); setDropoffLoc(null); setPrice(''); setDistance(''); setOrderDetail(''); setSelectedMerchantId(''); setItemCost(0); setCart({});
      
      if(currentUser.role !== 'driver' && currentUser.role !== 'user') {
         setActiveMenu('live_tracking');
         setTrackingOrderId(docRef.id);
      } else {
         alert('Pesanan berhasil dibuat!');
      }

    } catch (err) {
      console.error(err);
      alert("Gagal membuat pesanan.");
    }
  };

  const acceptOrder = async (orderId) => {
    if (!currentUser) return alert('Sesi habis.');
    setProcessingOrder(orderId);

    try {
      const dName = currentUser.name || 'Driver';
      const dWA = currentUser.wa || '-';
      const dPlate = currentUser.plate || '-'; 
      const dMotor = currentUser.motor || '-'; 
      const dVehicleType = currentUser.vehicleType || 'Motor'; 

      const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
      
      await updateDoc(orderRef, {
        status: 'accepted',
        driverName: dName,
        driverWA: dWA,
        driverPlate: dPlate,
        driverMotor: dMotor,
        driverVehicle: dVehicleType,
        takenAt: new Date().toISOString()
      });
      
      if(currentUser.role === 'driver') {
          setActiveMenu('dashboard'); 
      }
    } catch (err) { 
        console.error(err); 
        alert("Gagal mengambil order.");
    } finally {
        setProcessingOrder(null);
    }
  };

  const completeOrder = async (orderId) => {
     setCompletingOrder(orderId);
     try {
        const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
        await updateDoc(orderRef, { 
            status: 'completed',
            completedAt: new Date().toISOString()
        });
     } catch (err) {
        console.error(err);
        alert("Gagal menyelesaikan order.");
     } finally {
        setCompletingOrder(null);
     }
  };

  const cancelOrder = async (orderId) => {
     setProcessingOrder(orderId);
     try {
        const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
        await updateDoc(orderRef, { 
            status: 'cancelled'
        });
        if (activeMenu === 'live_tracking') {
            setActiveMenu('dashboard');
            setTrackingOrderId(null);
        }
     } catch (err) {
        console.error(err);
        alert("Gagal membatalkan order.");
     } finally {
        setProcessingOrder(null);
     }
  };

  const handleLogout = () => {
    localStorage.removeItem('ojekWargaUser');
    setCurrentUser(null); setSelectedRole(null); setAppState('landing'); setActiveMenu('dashboard');
    setRegName(''); setRegWA(''); setRegPlate(''); setRegMotor(''); setRegAddress(''); setRegPin(''); setInputPin(''); setRegVehicleType('Motor'); setRegMerchantName('');
    setIsFinanceUnlocked(false);
  };

  const generateWALink = (targetWA, role, order) => {
    const number = formatWA(targetWA);
    let message = '';
    
    if (role === 'driver') {
       message = `Halo ${order.customer}, saya ${order.driverName} (Driver OjekWarga). Saya terima orderan ${order.type === 'food' ? 'Makanan' : order.type === 'laundry' ? 'Laundry' : order.type === 'ride_car' ? 'Mobil' : order.type === 'ride_pickup' ? 'Pickup' : 'Ojek'} Anda. Segera saya jemput.`;
    } else {
       if (order.type === 'food') {
          const shopInfo = order.merchantName ? `di ${order.merchantName}` : '';
          message = `Halo Driver ${order.driverName}. Tolong belikan pesanan ${shopInfo}: "${order.orderDetail}". Total Belanja sekitar Rp ${order.itemCost?.toLocaleString() || '-'}.`;
       } else if (order.type === 'laundry') {
          message = `Halo Driver ${order.driverName}. Tolong jemput laundry saya.`;
       } else {
          message = `Halo Driver ${order.driverName}, saya tunggu di titik jemput ya.`;
       }
    }
    return `https://wa.me/${number}?text=${encodeURIComponent(message)}`;
  };

  const downloadReport = (financialList, type) => {
    let headers, rows;
    if (type === 'driver') {
        headers = ["Tanggal", "Nama Driver", "WhatsApp", "Total Order", "Pendapatan Kotor", "Potongan Admin (15%)", "Wajib Transfer", "Status"];
        rows = financialList.map(item => {
            const adminFee = item.gross * ADMIN_FEE_PERCENTAGE;
            const netIncome = item.gross - adminFee;
            const status = item.allPaid ? "Lunas" : "Belum Lunas";
            return [item.date, `"${item.name}"`, `'${item.wa}`, item.totalOrders, item.gross, adminFee, netIncome, status].join(",");
        });
    } else {
        // Merchant
        headers = ["Tanggal", "Nama Merchant", "Total Order", "Total Penjualan", "Potongan Admin (15%)", "Wajib Transfer", "Status"];
        rows = financialList.map(item => {
            const adminFee = item.totalSales * ADMIN_FEE_PERCENTAGE;
            const netIncome = item.totalSales - adminFee;
            const status = item.allPaid ? "Lunas" : "Belum Lunas";
            return [item.date, `"${item.name}"`, item.totalOrders, item.totalSales, adminFee, netIncome, status].join(",");
        });
    }

    const csvContent = [headers.join(","), ...rows].join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `Laporan_${type}_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const getMenuItems = () => {
    const role = currentUser?.role;
    const common = [{ id: 'profile', label: 'Profil Saya', icon: UserCircle }];
    
    if (role === 'user') {
       return [
          { id: 'dashboard', label: 'Beranda', icon: Home },
          { id: 'all_transactions', label: 'Semua Riwayat', icon: FileText }, 
          { id: 'manage_drivers', label: 'Kelola Driver', icon: UserCog }, 
          { id: 'financials', label: 'Laporan Keuangan', icon: Banknote }, 
          { id: 'pesan', label: 'Tes Order Ojek', icon: PlusCircle },
          { id: 'kirim_paket', label: 'Tes Merchant', icon: Package },
          { id: 'orderan_masuk', label: 'Monitor Driver', icon: Navigation },
       ];
    }

    const customerMenus = [
      { id: 'pesan', label: 'Pesan Ojek', icon: PlusCircle },
      { id: 'pesan_makanan', label: 'Pesan Makanan', icon: Utensils },
      { id: 'pesan_laundry', label: 'Pesan Laundry', icon: Shirt },
      { id: 'riwayat', label: 'Riwayat Saya', icon: History },
    ];
    const merchantMenus = [
      { id: 'manage_menu', label: 'Kelola Menu', icon: ListPlus }, 
      { id: 'merchant_financials', label: 'Laporan Penjualan', icon: TrendingUp }, // NEW MENU
      { id: 'kirim_paket', label: 'Kirim Paket', icon: Package }, 
      { id: 'riwayat', label: 'Riwayat Pengiriman', icon: History },
    ];
    const driverMenus = [
      { id: 'orderan_masuk', label: 'Orderan Masuk', icon: Navigation },
      { id: 'riwayat', label: 'Riwayat Order', icon: History },
    ];
    
    if (role === 'customer') return [{ id: 'dashboard', label: 'Beranda', icon: Home }, ...common, ...customerMenus];
    if (role === 'merchant') return [{ id: 'dashboard', label: 'Beranda', icon: Home }, ...common, ...merchantMenus];
    if (role === 'driver') return [{ id: 'dashboard', label: 'Beranda', icon: Home }, ...common, ...driverMenus];
    return [];
  };

  // --- Views ---
  // (Landing, Login, etc. same as before)
  if (appState === 'landing') { return ( <div className="min-h-screen bg-gradient-to-br from-yellow-300 via-orange-200 to-pink-300 flex items-center justify-center p-6 font-sans"><div className="max-w-5xl w-full text-center"><h1 className="text-5xl font-extrabold text-white drop-shadow-md mb-4">Ojek<span className="text-yellow-500 bg-white px-2 rounded-lg ml-1">Warga</span></h1><p className="text-white text-xl font-medium drop-shadow-sm mb-12">Pilih Peran Anda</p><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{[{ id: 'driver', label: 'Driver', icon: Bike, color: 'text-green-600', bg: 'bg-green-100' }, { id: 'customer', label: 'Penumpang', icon: User, color: 'text-blue-600', bg: 'bg-blue-100' }, { id: 'merchant', label: 'Merchant', icon: Store, color: 'text-orange-600', bg: 'bg-orange-100' }, { id: 'user', label: 'Admin', icon: LayoutDashboard, color: 'text-purple-600', bg: 'bg-purple-100' }].map(role => (<button key={role.id} onClick={() => handleRoleSelect(role.id)} className="group bg-white/90 hover:bg-white p-6 rounded-3xl shadow-xl transition-all transform hover:-translate-y-2"><div className={`${role.bg} p-4 rounded-full mb-4 mx-auto w-fit`}><role.icon size={40} className={role.color} /></div><h2 className="text-lg font-bold text-gray-800">{role.label}</h2></button>))}</div></div></div> ); }
  if (appState === 'admin_login') { return ( <div className="min-h-screen bg-purple-50 flex items-center justify-center p-6"><div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center border-t-4 border-purple-600"><h2 className="text-2xl font-bold mb-1 text-purple-900">Admin Access Only</h2><form onSubmit={handleAdminLogin} className="space-y-6"><div className="relative"><input type={showPin ? "text" : "password"} value={inputPin} onChange={e => setInputPin(e.target.value)} className="w-full p-4 border-2 border-purple-100 focus:border-purple-500 rounded-xl text-center text-2xl tracking-[0.5em] font-bold outline-none" maxLength={6} placeholder="******" autoFocus/><button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-4 top-5 text-gray-400">{showPin ? <EyeOff size={20}/> : <Eye size={20}/>}</button></div><button type="submit" className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700">Buka Dashboard</button><button type="button" onClick={() => setAppState('landing')} className="w-full text-gray-400 text-sm">Kembali</button></form></div></div> ); }
  if (appState === 'check_user') { return ( <div className="min-h-screen bg-gray-50 flex items-center justify-center p-6"><div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8"><h2 className="text-2xl font-bold mb-2 text-center">Masuk Aplikasi</h2><form onSubmit={checkUserExists} className="space-y-4"><div><label className="block text-sm font-bold text-gray-700 mb-1">Nomor WhatsApp</label><div className="relative"><Phone size={18} className="absolute left-3 top-3.5 text-gray-400"/><input required type="text" value={regWA} onChange={e => setRegWA(e.target.value)} className="w-full pl-10 p-3 border rounded-xl" placeholder="0812345678" /></div></div><button type="submit" disabled={isCheckingUser} className="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-black flex justify-center items-center">{isCheckingUser ? <Loader2 className="animate-spin"/> : <><span className="mr-2">Lanjut</span> <ArrowRight size={18}/></>}</button><button type="button" onClick={() => setAppState('landing')} className="w-full text-gray-400 text-sm mt-2">Kembali</button></form></div></div> ); }
  if (appState === 'login_pin') { return ( <div className="min-h-screen bg-gray-50 flex items-center justify-center p-6"><div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center"><h2 className="text-2xl font-bold mb-1">Masukkan PIN</h2><p className="text-gray-500 text-sm mb-6">Halo, <b>{foundUser?.name}</b>!</p><form onSubmit={handleVerifyPin} className="space-y-6"><div className="relative"><input type={showPin ? "text" : "password"} value={inputPin} onChange={e => setInputPin(e.target.value)} className="w-full p-4 border rounded-xl text-center text-2xl tracking-[0.5em] font-bold" maxLength={6} placeholder="••••••" autoFocus/><button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-4 top-5 text-gray-400">{showPin ? <EyeOff size={20}/> : <Eye size={20}/>}</button></div><button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700">Buka Aplikasi</button><div className="flex justify-between mt-4"><button type="button" onClick={() => setAppState('check_user')} className="text-gray-400 text-sm hover:text-gray-600">Bukan akun ini?</button><button type="button" onClick={handleForgotPinRequest} className="text-blue-500 text-sm font-bold hover:text-blue-700">Lupa PIN?</button></div></form></div></div> ); }
  if (appState === 'forgot_pin') { return ( <div className="min-h-screen bg-gray-50 flex items-center justify-center p-6"><div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8"><h2 className="text-xl font-bold text-center">Reset PIN Aman</h2><form onSubmit={handleVerifyOtpAndReset} className="space-y-4 mt-6 border-t pt-6"><div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Kode Otorisasi</label><input required type="password" value={otp} onChange={e => setOtp(e.target.value)} className="w-full p-3 border rounded-xl text-center tracking-widest font-bold bg-gray-50 text-xl" placeholder="******" maxLength={6}/></div><div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Buat PIN Baru</label><input required type="text" value={regPin} onChange={e => setRegPin(e.target.value)} className="w-full pl-10 p-3 border rounded-xl" placeholder="6 Angka Baru" maxLength={6}/></div><button type="submit" className="w-full bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 mt-2">Ganti PIN</button><button type="button" onClick={() => setAppState('login_pin')} className="w-full text-gray-400 text-sm mt-2">Batal</button></form></div></div> ); }
  if (appState === 'register') { return ( <div className="min-h-screen bg-gray-50 flex items-center justify-center p-6"><div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8"><h2 className="text-2xl font-bold text-center mb-6">Buat Akun</h2><form onSubmit={handleRegister} className="space-y-4"><div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Nama Lengkap</label><input required type="text" value={regName} onChange={e => setRegName(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Nama Anda" /></div>{selectedRole === 'merchant' && (<div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Nama Merchant / Toko</label><input required type="text" value={regMerchantName} onChange={e => setRegMerchantName(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Contoh: Kedai Kopi Senja" /></div>)}<div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Alamat {selectedRole === 'merchant' ? 'Toko' : selectedRole === 'driver' ? 'Tinggal' : 'Rumah / Domisili'}</label><input required type="text" value={regAddress} onChange={e => setRegAddress(e.target.value)} className="w-full pl-10 p-3 border rounded-xl" placeholder="Nama Jalan, Blok, Nomor" /></div><div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Buat PIN (6 Angka)</label><input required type={showPin ? "text" : "password"} value={regPin} onChange={e => setRegPin(e.target.value)} className="w-full pl-10 p-3 border rounded-xl font-mono" placeholder="123456" maxLength={6}/></div>{selectedRole === 'driver' && (<div className="space-y-3"><div><label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Jenis Kendaraan</label><div className="grid grid-cols-3 gap-2">{['Motor', 'Mobil', 'Mobil Pickup'].map(type => (<button key={type} type="button" onClick={() => setRegVehicleType(type)} className={`p-2 rounded-lg text-xs font-bold border transition-all ${regVehicleType === type ? 'bg-green-100 border-green-500 text-green-700' : 'bg-white border-gray-200 text-gray-500'}`}>{type}</button>))}</div></div><div className="grid grid-cols-2 gap-2"><input required type="text" value={regMotor} onChange={e => setRegMotor(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Merk Motor" /><input required type="text" value={regPlate} onChange={e => setRegPlate(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Plat Nomor" /></div></div>)}<button type="submit" className="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">Simpan & Masuk</button><button onClick={() => setAppState('landing')} className="w-full text-gray-400 text-sm mt-2">Batal</button></form></div></div> ); }

  if (activeMenu === 'manage_drivers' && currentUser?.role === 'user') { return ( <div className="flex h-screen bg-gray-50 font-sans"><aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-white border-r transform transition ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}><div className="p-6 font-extrabold text-2xl text-gray-800 flex items-center"><Bike className="text-yellow-500 mr-2"/>OjekWarga</div><nav className="flex-1 px-4 space-y-2 overflow-y-auto">{getMenuItems().map(item => (<button key={item.id} onClick={() => {setActiveMenu(item.id); setIsMobileMenuOpen(false); setCurrentPage(1);}} className={`w-full flex items-center p-3 rounded-xl font-bold transition ${activeMenu === item.id ? 'bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><item.icon size={20} className="mr-3"/> {item.label}</button>))}</nav><button onClick={handleLogout} className="m-4 p-3 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-xl font-bold"><LogOut size={20} className="mr-2"/> Keluar</button></aside><main className="flex-1 flex flex-col h-screen overflow-hidden relative"><div className="md:hidden bg-white p-4 border-b flex justify-between items-center"><span className="font-bold">OjekWarga</span><button onClick={() => setIsMobileMenuOpen(true)}><Menu/></button></div><div className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50"><div className="max-w-4xl mx-auto"><h2 className="text-2xl font-bold mb-6">Kelola Akun Driver</h2>{loadingDrivers ? (<div className="text-center p-8"><Loader2 className="animate-spin mx-auto"/></div>) : (<div className="grid gap-4">{driversList.map(driver => (<div key={driver.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100"><div><div className="font-bold text-lg flex items-center">{driver.name}{driver.status === 'suspended' && <span className="ml-2 px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full font-bold">SUSPENDED</span>}</div><div className="text-sm text-gray-500">{driver.wa} • {driver.vehicleType || 'Motor'} ({driver.plate})</div></div><button onClick={() => toggleDriverStatus(driver.id, driver.status)} disabled={processingDriverId === driver.id} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center transition-all ${driver.status === 'suspended' ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}>{processingDriverId === driver.id ? <Loader2 size={16} className="animate-spin"/> : (driver.status === 'suspended' ? 'Aktifkan' : 'Matikan')}</button></div>))}</div>)}</div></div></main></div> ); }

  // --- ADMIN & MERCHANT: FINANCIALS / SALES REPORT VIEW ---
  if ((activeMenu === 'financials' && currentUser?.role === 'user') || (activeMenu === 'merchant_financials' && currentUser?.role === 'merchant')) {
      
      // Auth Check for Admin Financials
      if (activeMenu === 'financials' && !isFinanceUnlocked) { return ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl"><h3 className="text-xl font-bold mb-2">Akses Terbatas</h3><p className="text-gray-500 text-sm mb-6">PIN Owner:</p><form onSubmit={verifyFinancePin}><input type="password" className="w-full p-3 border rounded-xl text-center text-xl tracking-widest font-bold mb-4" maxLength={6} value={financePinInput} onChange={e => setFinancePinInput(e.target.value)} autoFocus/><div className="flex gap-2"><button type="button" onClick={() => setShowFinancePinModal(false)} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl">Batal</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700">Buka</button></div></form></div></div> ); }
      
      // Determine Mode: Admin Driver Report, Admin Merchant Report, or Merchant Personal Report
      // Simple toggle for Admin
      
      const isAdmin = currentUser?.role === 'user';
      const reportType = isAdmin ? (financeTab === 'driver' ? 'driver' : 'merchant') : 'merchant'; 
      
      // Process Data
      const reportData = {};
      orders.filter(o => o.status === 'completed').forEach(order => {
          // Filter for Merchant Personal View
          if (!isAdmin && order.merchantName !== currentUser.merchantName) return;

          let dateStr = 'Unknown';
          if (order.completedAt) dateStr = new Date(order.completedAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric'});
          else if (order.date) dateStr = order.date.split(',')[0];

          if (reportType === 'driver') {
              // Logic Driver Report (Admin View)
              const dName = order.driverName || 'Unknown';
              const dWA = order.driverWA || 'Unknown';
              const key = `${dName}-${dWA}-${dateStr}`;
              if (!reportData[key]) reportData[key] = { name: dName, wa: dWA, date: dateStr, totalOrders: 0, gross: 0, orderIds: [], allPaid: true };
              reportData[key].totalOrders += 1;
              reportData[key].gross += order.price; // Driver gets 'price' (ongkir)
              reportData[key].orderIds.push(order.id);
              if (!order.isPaidOut) reportData[key].allPaid = false;

          } else {
              // Logic Merchant Report (Admin & Merchant View)
              if (!order.itemCost || order.itemCost === 0) return; // Skip orders without merchant items
              const mName = order.merchantName || 'Unknown';
              const key = `${mName}-${dateStr}`;
              if (!reportData[key]) reportData[key] = { name: mName, date: dateStr, totalOrders: 0, totalSales: 0, orderIds: [], allPaid: true };
              reportData[key].totalOrders += 1;
              reportData[key].totalSales += order.itemCost; // Merchant gets 'itemCost'
              reportData[key].orderIds.push(order.id);
              if (!order.isMerchantPaid) reportData[key].allPaid = false;
          }
      });
      
      const financialList = Object.values(reportData);
      const indexOfLastItem = currentPage * ITEMS_PER_PAGE;
      const indexOfFirstItem = indexOfLastItem - ITEMS_PER_PAGE;
      const currentItems = financialList.slice(indexOfFirstItem, indexOfLastItem);
      const totalPages = Math.ceil(financialList.length / ITEMS_PER_PAGE);
      const paginate = (pageNumber) => setCurrentPage(pageNumber);

      return (
          <div className="flex h-screen bg-gray-50 font-sans">
              <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-white border-r transform transition ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                <div className="p-6 font-extrabold text-2xl text-gray-800 flex items-center"><Bike className="text-yellow-500 mr-2"/>OjekWarga</div>
                <nav className="flex-1 px-4 space-y-2 overflow-y-auto">{getMenuItems().map(item => (<button key={item.id} onClick={() => { if (item.id === 'financials') handleFinanceMenuClick(); else { setActiveMenu(item.id); setIsMobileMenuOpen(false); setCurrentPage(1); } }} className={`w-full flex items-center p-3 rounded-xl font-bold transition ${activeMenu === item.id ? 'bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><item.icon size={20} className="mr-3"/> {item.label}</button>))}</nav>
                <button onClick={handleLogout} className="m-4 p-3 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-xl font-bold"><LogOut size={20} className="mr-2"/> Keluar</button>
              </aside>
              <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                  <div className="md:hidden bg-white p-4 border-b flex justify-between items-center"><span className="font-bold">OjekWarga</span><button onClick={() => setIsMobileMenuOpen(true)}><Menu/></button></div>
                  <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
                      <div className="max-w-5xl mx-auto">
                          <div className="flex justify-between items-center mb-6">
                              <h2 className="text-2xl font-bold">{isAdmin ? 'Laporan Keuangan' : 'Laporan Penjualan Saya'}</h2>
                              <button onClick={() => downloadReport(financialList, reportType)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow flex items-center font-bold transition"><Download size={18} className="mr-2"/> Excel</button>
                          </div>
                          
                          {/* ADMIN TABS */}
                          {isAdmin && (
                              <div className="flex bg-gray-200 p-1 rounded-xl mb-6 w-fit">
                                  <button onClick={() => {setFinanceTab('driver'); setCurrentPage(1);}} className={`px-6 py-2 rounded-lg font-bold text-sm transition ${financeTab === 'driver' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>Laporan Driver</button>
                                  <button onClick={() => {setFinanceTab('merchant'); setCurrentPage(1);}} className={`px-6 py-2 rounded-lg font-bold text-sm transition ${financeTab === 'merchant' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>Laporan Merchant</button>
                              </div>
                          )}

                          <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 flex items-start"><Info className="text-blue-500 mr-3 flex-shrink-0 mt-1" /><div className="text-sm text-blue-800"><p className="font-bold">Informasi Bagi Hasil:</p><p>Potongan admin: <b>15%</b>.</p><p>Kolom <b>"Wajib Transfer"</b> adalah bersih yang harus dibayarkan ke {reportType === 'driver' ? 'Driver' : 'Merchant'}.</p></div></div>
                          
                          <div className="bg-white rounded-2xl shadow overflow-hidden flex flex-col h-[600px]">
                              <div className="overflow-x-auto flex-1">
                                  <table className="w-full text-left text-sm">
                                      <thead className="bg-gray-100 border-b sticky top-0 z-10">
                                          <tr>
                                              <th className="p-4 font-bold text-gray-600">Tanggal</th>
                                              <th className="p-4 font-bold text-gray-600">Nama {reportType === 'driver' ? 'Driver' : 'Merchant'}</th>
                                              <th className="p-4 font-bold text-gray-600 text-center">Order Selesai</th>
                                              <th className="p-4 font-bold text-gray-600 text-right">Total Kotor</th>
                                              <th className="p-4 font-bold text-red-500 text-right">Potongan (15%)</th>
                                              <th className="p-4 font-bold text-green-600 text-right">Wajib Transfer</th>
                                              <th className="p-4 text-center">Status Transfer</th>
                                              {isAdmin && <th className="p-4 text-center">Aksi</th>}
                                          </tr>
                                      </thead>
                                      <tbody className="divide-y overflow-y-auto">
                                          {currentItems.map((item, idx) => {
                                              const rawTotal = reportType === 'driver' ? item.gross : item.totalSales;
                                              const adminFee = rawTotal * ADMIN_FEE_PERCENTAGE;
                                              const netIncome = rawTotal - adminFee;
                                              const uniqueKey = `${item.name}-${item.date}-${idx}`;
                                              
                                              return (
                                                  <tr key={uniqueKey} className="hover:bg-gray-50">
                                                      <td className="p-4"><div className="flex items-center font-medium text-gray-700"><Calendar size={14} className="mr-2 text-blue-500"/>{item.date}</div></td>
                                                      <td className="p-4"><div className="font-bold">{item.name}</div>{reportType === 'driver' && <div className="text-xs text-gray-400">{item.wa}</div>}</td>
                                                      <td className="p-4 text-center font-bold">{item.totalOrders}</td>
                                                      <td className="p-4 text-right">Rp {rawTotal.toLocaleString()}</td>
                                                      <td className="p-4 text-right text-red-500">- Rp {adminFee.toLocaleString()}</td>
                                                      <td className="p-4 text-right font-bold text-green-600 bg-green-50">Rp {netIncome.toLocaleString()}</td>
                                                      <td className="p-4 text-center">
                                                          {item.allPaid ? <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200"><CheckSquare size={12} className="mr-1"/> Lunas</span> : 
                                                          (isAdmin ? <button onClick={() => reportType === 'driver' ? markAsPaid(uniqueKey, item.orderIds) : markMerchantAsPaid(uniqueKey, item.orderIds)} disabled={markingPaid === uniqueKey} className={`px-3 py-1 rounded-lg text-xs font-bold shadow-sm transition ${markingPaid === uniqueKey ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}`}>{markingPaid === uniqueKey ? <Loader2 size={12} className="animate-spin"/> : "Tandai Selesai"}</button> : <span className="text-yellow-600 font-bold text-xs">Menunggu</span>)}
                                                      </td>
                                                      {isAdmin && reportType === 'driver' && (
                                                        <td className="p-4 text-center"><a href={`https://wa.me/${formatWA(item.wa)}`} target="_blank" className="bg-green-500 text-white p-2 rounded-lg inline-flex hover:bg-green-600"><MessageCircle size={16}/></a></td>
                                                      )}
                                                      {/* Merchant doesn't have direct WA link in this structure easily accessible without extra lookup, skipping for now or add later */}
                                                      {isAdmin && reportType === 'merchant' && <td className="p-4 text-center text-gray-400">-</td>}
                                                  </tr>
                                              );
                                          })}
                                          {financialList.length === 0 && <tr><td colSpan="8" className="p-8 text-center text-gray-400">Belum ada data transaksi.</td></tr>}
                                      </tbody>
                                  </table>
                              </div>
                              {financialList.length > 0 && (<div className="p-4 border-t bg-gray-50 flex items-center justify-between"><span className="text-sm text-gray-500">Halaman {currentPage} / {totalPages}</span><div className="flex items-center space-x-2"><button onClick={() => paginate(currentPage - 1)} disabled={currentPage === 1} className="p-2 rounded-lg border bg-white hover:bg-gray-50"><ChevronLeft size={20}/></button><button onClick={() => paginate(currentPage + 1)} disabled={currentPage === totalPages} className="p-2 rounded-lg border bg-white hover:bg-gray-50"><ChevronRight size={20}/></button></div></div>)}
                          </div>
                      </div>
                  </div>
              </main>
          </div>
      );
  }

  if (activeMenu === 'manage_menu' && currentUser?.role === 'merchant') {
      return (
          <div className="flex h-screen bg-gray-50 font-sans">
              <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-white border-r transform transition ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                <div className="p-6 font-extrabold text-2xl text-gray-800 flex items-center"><Bike className="text-yellow-500 mr-2"/>OjekWarga</div>
                <nav className="flex-1 px-4 space-y-2 overflow-y-auto">{getMenuItems().map(item => (<button key={item.id} onClick={() => {setActiveMenu(item.id); setIsMobileMenuOpen(false);}} className={`w-full flex items-center p-3 rounded-xl font-bold transition ${activeMenu === item.id ? 'bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><item.icon size={20} className="mr-3"/> {item.label}</button>))}</nav>
                <button onClick={handleLogout} className="m-4 p-3 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-xl font-bold"><LogOut size={20} className="mr-2"/> Keluar</button>
              </aside>
              <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                  <div className="md:hidden bg-white p-4 border-b flex justify-between items-center"><span className="font-bold">OjekWarga</span><button onClick={() => setIsMobileMenuOpen(true)}><Menu/></button></div>
                  <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50"><div className="max-w-2xl mx-auto"><h2 className="text-2xl font-bold mb-6">Kelola Menu: {currentUser.merchantName}</h2><Card className="mb-6"><h3 className="font-bold text-lg mb-4">Tambah Menu Baru</h3><form onSubmit={addMenuItem} className="flex gap-2"><input type="text" value={newItemName} onChange={e => setNewItemName(e.target.value)} placeholder="Nama Item" className="flex-1 p-3 border rounded-xl" required /><input type="number" value={newItemPrice} onChange={e => setNewItemPrice(e.target.value)} placeholder="Harga" className="w-32 p-3 border rounded-xl" required /><button type="submit" className="bg-green-600 text-white p-3 rounded-xl hover:bg-green-700"><PlusCircle size={24}/></button></form></Card><h3 className="font-bold text-lg mb-4">Daftar Menu</h3><div className="space-y-2">{merchantMenu.length === 0 ? (<div className="text-gray-400 text-center p-8 border border-dashed rounded-xl bg-white">Belum ada menu.</div>) : (merchantMenu.map(item => (<div key={item.id} className="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100"><div><div className="font-bold text-gray-800">{item.name}</div><div className="text-sm text-gray-500">Rp {item.price.toLocaleString()}</div></div><button onClick={() => deleteMenuItem(item.id)} className="text-red-400 hover:text-red-600 p-2"><Trash size={20}/></button></div>)))}</div></div></div>
              </main>
          </div>
      );
  }

  return (
    <div className="flex h-screen bg-gray-50 font-sans">
      {/* Sidebar */}
      <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-white border-r transform transition ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
        <div className="p-6 font-extrabold text-2xl text-gray-800 flex items-center"><Bike className="text-yellow-500 mr-2"/>OjekWarga</div>
        <nav className="flex-1 px-4 space-y-2 overflow-y-auto">
          {getMenuItems().map(item => (
             <button key={item.id} onClick={() => {
                 if (item.id === 'financials') handleFinanceMenuClick();
                 else { setActiveMenu(item.id); setIsMobileMenuOpen(false); setCurrentPage(1); }
             }} className={`w-full flex items-center p-3 rounded-xl font-bold transition ${activeMenu === item.id ? 'bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}>
               <item.icon size={20} className="mr-3"/> {item.label}
             </button>
          ))}
        </nav>
        <button onClick={handleLogout} className="m-4 p-3 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-xl font-bold"><LogOut size={20} className="mr-2"/> Keluar</button>
      </aside>

      <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center">
           <span className="font-bold">OjekWarga</span>
           <button onClick={() => setIsMobileMenuOpen(true)}><Menu/></button>
        </div>
        <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
          
          {activeMenu === 'dashboard' && (
             <div className="max-w-4xl mx-auto">
                <h2 className="text-3xl font-bold text-gray-800 mb-6">Halo, {currentUser.name} 👋</h2>
                <div className="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl p-6 text-white shadow-lg mb-8">
                    <h3 className="font-bold text-lg mb-4 flex items-center">
                        <Headphones size={24} className="mr-2"/> Pusat Bantuan (Call Center)
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <a href="https://wa.me/6281311314203" target="_blank" rel="noreferrer" className="flex items-center justify-center bg-white text-gray-900 py-3 rounded-xl font-bold hover:bg-gray-100 transition shadow-sm"><MessageCircle size={20} className="mr-2 text-green-600"/> 0813-1131-4203</a>
                        <a href="https://wa.me/6281299988548" target="_blank" rel="noreferrer" className="flex items-center justify-center bg-white text-gray-900 py-3 rounded-xl font-bold hover:bg-gray-100 transition shadow-sm"><MessageCircle size={20} className="mr-2 text-green-600"/> 0812-9998-8548</a>
                    </div>
                </div>

                <h3 className="font-bold text-xl mb-4">Orderan Berjalan</h3>
                {getMyOrders().filter(o => o.status === 'pending' || o.status === 'accepted').map(order => (
                   <Card key={order.id} className="mb-4 border-l-4 border-blue-500 shadow-md">
                      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                         <div className="flex-1">
                            <Badge status={order.status} type={order.type} />
                            <div className="font-bold mt-2 text-lg">{order.pickup} <span className="text-gray-400 mx-2">➔</span> {order.dropoff}</div>
                            {order.orderDetail && <div className="text-sm mt-2 p-2 bg-gray-50 rounded border border-gray-200 inline-block"><span className="font-bold text-gray-600">{order.type === 'food' ? 'Pesanan:' : 'Catatan:'}</span> {order.orderDetail}</div>}
                            <div className="text-sm text-gray-500 mt-1">Ongkir: Rp {order.price.toLocaleString()}</div>
                            {order.status === 'accepted' && (<div className="mt-4 bg-blue-50 p-3 rounded-xl border border-blue-100"><p className="text-xs text-blue-600 font-bold uppercase mb-1">Info Kontak</p><div className="font-bold text-gray-800 text-lg">{currentUser.role === 'driver' ? order.customer : order.driverName}</div></div>)}
                         </div>
                         {order.status === 'accepted' && (<div className="flex flex-col gap-2 w-full md:w-auto"><div className="flex gap-2"><a href={generateWALink(currentUser.role === 'driver' ? order.customerWA : order.driverWA, currentUser.role, order)} target="_blank" rel="noreferrer" className="flex-1 flex items-center justify-center bg-green-500 text-white px-4 py-3 rounded-xl font-bold shadow hover:bg-green-600 transition"><MessageCircle size={20} className="mr-2"/> WA</a><a href={`tel:${currentUser.role === 'driver' ? order.customerWA : order.driverWA}`} className="flex-1 flex items-center justify-center bg-gray-700 text-white px-4 py-3 rounded-xl font-bold shadow hover:bg-gray-800 transition"><PhoneCall size={20} className="mr-2"/> Call</a></div>{currentUser.role === 'driver' && (<button onClick={() => completeOrder(order.id)} disabled={completingOrder === order.id} className={`w-full px-4 py-3 rounded-xl font-bold shadow flex items-center justify-center mt-2 transition-all ${completingOrder === order.id ? 'bg-gray-300 text-gray-500' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>{completingOrder === order.id ? <Loader2 className="animate-spin mr-2"/> : <Flag size={20} className="mr-2"/>} {completingOrder === order.id ? 'Proses...' : 'Selesai Antar'}</button>)}</div>)}
                         {(currentUser.role === 'customer' || currentUser.role === 'merchant') && order.status === 'pending' && (<div className="w-full md:w-auto"><button onClick={() => { setTrackingOrderId(order.id); setActiveMenu('live_tracking'); }} className="w-full bg-yellow-100 text-yellow-700 px-4 py-3 rounded-xl font-bold shadow-sm hover:bg-yellow-200 flex items-center justify-center transition"><Search size={20} className="mr-2"/> Lihat Status / Batal</button></div>)}
                      </div>
                   </Card>
                ))}
                {getMyOrders().filter(o => o.status === 'pending' || o.status === 'accepted').length === 0 && <div className="p-8 text-center bg-white rounded-xl border border-dashed text-gray-400">Tidak ada pesanan aktif saat ini.</div>}
             </div>
          )}
          
          {['pesan', 'kirim_paket', 'pesan_makanan', 'pesan_laundry'].includes(activeMenu) && (
            <div className="max-w-xl mx-auto">
               <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                 {activeMenu === 'pesan_makanan' && <><Utensils className="mr-2 text-orange-500"/> Pesan Makanan</>}
                 {activeMenu === 'pesan_laundry' && <><Shirt className="mr-2 text-cyan-500"/> Pesan Laundry</>}
                 {activeMenu === 'pesan' && <><PlusCircle className="mr-2 text-blue-500"/> Pesan Ojek</>}
                 {activeMenu === 'kirim_paket' && <><Package className="mr-2 text-purple-500"/> Kirim Paket</>}
               </h2>
               <Card>
                 <form onSubmit={addOrder} className="space-y-4">
                    {activeMenu === 'pesan' && (
                       <div className="grid grid-cols-3 gap-2 bg-gray-100 p-1 rounded-lg mb-4">
                          <button type="button" onClick={() => {setSelectedVehicle('Motor');}} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${selectedVehicle === 'Motor' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Motor</button>
                          <button type="button" onClick={() => {setSelectedVehicle('Mobil');}} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${selectedVehicle === 'Mobil' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Mobil</button>
                          <button type="button" onClick={() => {setSelectedVehicle('Mobil Pickup');}} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${selectedVehicle === 'Mobil Pickup' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Pickup</button>
                       </div>
                    )}

                    {(activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') && (
                        <div className="mb-6">
                            <label className="block text-gray-700 font-bold mb-2 text-sm">Pilih Mitra {activeMenu === 'pesan_laundry' ? 'Laundry' : 'Toko/Resto'}</label>
                            <select 
                                value={selectedMerchantId} 
                                onChange={handleMerchantSelect} 
                                className="w-full p-3 border rounded-xl bg-white text-sm focus:ring-2 focus:ring-orange-500 outline-none mb-4"
                            >
                                <option value="">-- Pilih dari Daftar --</option>
                                {merchantList.map(m => (<option key={m.id} value={m.id}>{m.merchantName}</option>))}
                            </select>
                            {selectedMerchantId && (
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <h4 className="font-bold text-sm text-gray-700 mb-3">Daftar Menu / Layanan:</h4>
                                    <div className="space-y-3">
                                        {merchantMenu.length === 0 ? (<p className="text-xs text-gray-400 text-center">Belum ada menu tersedia di toko ini.</p>) : (merchantMenu.map(item => { const qty = cart[item.id] || 0; return (<div key={item.id} className="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100 shadow-sm"><div><div className="font-bold text-sm text-gray-800">{item.name}</div><div className="text-xs text-orange-600">Rp {item.price.toLocaleString()}</div></div><div className="flex items-center bg-gray-100 rounded-lg"><button type="button" onClick={() => updateCart(item.id, -1)} className="px-3 py-1 text-gray-600 hover:bg-gray-200 rounded-l-lg font-bold">-</button><span className="px-2 text-sm font-bold w-8 text-center">{qty}</span><button type="button" onClick={() => updateCart(item.id, 1)} className="px-3 py-1 text-blue-600 hover:bg-blue-100 rounded-r-lg font-bold">+</button></div></div>); }))}
                                    </div>
                                    <div className="mt-4 pt-3 border-t flex justify-between items-center"><span className="text-sm font-bold text-gray-600">Total Belanja:</span><span className="text-lg font-bold text-orange-600">Rp {itemCost.toLocaleString()}</span></div>
                                </div>
                            )}
                        </div>
                    )}

                    <LocationSearchInput 
                        label="Lokasi Jemput" 
                        placeholder="Ketik Nama Jalan..." 
                        onSelect={setPickupLoc} 
                        initialValue={
                            activeMenu === 'kirim_paket' ? currentUser.shopAddress : 
                            (selectedMerchantId && pickupLoc) ? pickupLoc.name : ''
                        }
                        readOnly={false} // Fix: always editable
                    />
                    <LocationSearchInput label="Lokasi Tujuan" placeholder="Ketik Nama Jalan, Gang..." onSelect={setDropoffLoc}/>
                    
                    {activeMenu === 'kirim_paket' && <div><label className="block text-gray-700 font-bold mb-1 text-sm">Nama Penerima</label><input type="text" value={orderDetail} onChange={e => setOrderDetail(e.target.value)} className="w-full p-3 border rounded-xl" required /></div>}
                    
                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mt-4">
                       {isCalculating ? <div className="flex justify-center py-4 text-gray-500"><Loader2 className="animate-spin mr-2"/> Menghitung...</div> : 
                       <div className="grid grid-cols-2 gap-4">
                           <div><label className="text-xs font-bold text-gray-500">Jarak</label><div className="text-xl font-bold">{distance} KM</div></div>
                           <div>
                               <label className="text-xs font-bold text-gray-500">Ongkir Driver</label>
                               <div className="text-xl font-bold text-blue-600">Rp {price}</div>
                           </div>
                           {(activeMenu === 'pesan_makanan' || activeMenu === 'pesan_laundry') && (
                               <div className="col-span-2 mt-2 pt-2 border-t">
                                   <label className="text-xs font-bold text-gray-500 uppercase">Total Bayar (Belanja + Ongkir)</label>
                                   <div className="text-2xl font-bold text-green-600">Rp {(parseInt(price || 0) + itemCost).toLocaleString()}</div>
                                   <p className="text-[10px] text-gray-400">*Bayar tunai ke driver saat barang sampai.</p>
                               </div>
                           )}
                       </div>}
                    </div>
                    <button type="submit" disabled={!price} className="w-full bg-gray-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg mt-4">Cari Driver</button>
                 </form>
               </Card>
            </div>
          )}
          
          {activeMenu === 'profile' && (
             <div className="max-w-xl mx-auto">
                <h2 className="text-2xl font-bold mb-6">Profil Saya</h2>
                <div className="bg-white p-6 rounded-xl shadow"><p className="font-bold text-lg">{currentUser.name}</p><p>{currentUser.wa}</p></div>
             </div>
          )}

        </div>
      </main>
    </div>
  );
}